<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrono-Chai | PadhaiLikhai</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        /*
         * Chrono-Chai - Cyber-Neon Game Theme
         * Designed & Developed by Sagar Raj & Gemini
         */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto+Mono:wght@700&display=swap');

        :root {
            --background-dark: #050a19;
            --background-light: #10162F;
            --primary-text: #e0e0e0;
            --secondary-text: #a0a0c0;
            --accent-neon: #00ffff;
            --accent-glow: rgba(0, 255, 255, 0.5);
            --accent-shadow: rgba(0, 255, 255, 0.2);
            --danger-color: #ff4757;
            --success-color: #2ed573;
            --warning-color: #ffa502;
            --glass-bg: rgba(16, 22, 47, 0.7);
            --border-color: rgba(0, 255, 255, 0.25);
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(-45deg, var(--background-light), var(--background-dark), #0d121f, #10162F);
            background-size: 400% 400%;
            animation: gradientBG 25s ease infinite;
            color: var(--primary-text);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes pulseGlow { 0% { box-shadow: 0 0 15px var(--accent-glow); } 50% { box-shadow: 0 0 30px var(--accent-glow); } 100% { box-shadow: 0 0 15px var(--accent-glow); } }

        #game-container {
            width: 100%;
            height: 100%;
            max-width: 1200px;
            max-height: 800px;
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 15px 35px var(--shadow-color);
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }

        /* --- HUD (Heads-Up Display) --- */
        #hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(5, 10, 25, 0.5);
            border-radius: 10px 10px 0 0;
            font-family: 'Roboto Mono', monospace;
        }
        .hud-item { text-align: center; }
        .hud-item span { font-size: 1.5rem; color: var(--accent-neon); text-shadow: 0 0 8px var(--accent-glow); }
        .hud-item p { font-size: 0.8rem; text-transform: uppercase; color: var(--secondary-text); }
        #player-lives i { color: var(--danger-color); text-shadow: 0 0 5px var(--danger-color); transition: transform 0.3s; }

        /* --- Main Game Area --- */
        #main-game-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }

        #stall-area {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        #customer-portrait {
            width: 150px;
            height: 150px;
            border: 3px solid var(--accent-neon);
            border-radius: 50%;
            box-shadow: 0 0 20px var(--accent-glow), inset 0 0 15px var(--accent-shadow);
            background-size: cover;
            background-position: center;
            transition: transform 0.5s, box-shadow 0.5s;
        }
        #customer-name {
            margin-top: 10px;
            font-size: 1.5rem;
            font-weight: 700;
            text-shadow: 0 0 5px var(--accent-glow);
        }

        #trivia-area {
            text-align: center;
        }
        #timer-bar {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 4px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        #timer-progress {
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--warning-color), var(--danger-color));
            border-radius: 4px;
            transition: width 0.1s linear;
        }
        #question-text {
            font-size: 1.2rem;
            min-height: 60px;
            color: var(--primary-text);
            margin-bottom: 20px;
        }
        #answer-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .answer-btn {
            padding: 15px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-text);
            background: var(--glass-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .answer-btn:hover:not(:disabled) {
            background: var(--accent-shadow);
            border-color: var(--accent-neon);
            transform: translateY(-5px);
        }
        .answer-btn.correct { background: var(--success-color); border-color: var(--success-color); color: #000; }
        .answer-btn.wrong { background: var(--danger-color); border-color: var(--danger-color); color: #000; }

        /* --- Modals and Overlays --- */
        .modal-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 10, 25, 0.9);
            backdrop-filter: blur(10px);
            z-index: 100;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.5s ease;
        }
        .modal-content {
            background: linear-gradient(145deg, var(--background-light), var(--background-dark));
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 0 30px var(--accent-shadow);
            animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: 90%;
            max-width: 500px;
        }
        .modal-content h2 { font-size: 2.5rem; margin-bottom: 15px; text-shadow: 0 0 8px var(--accent-glow); }
        .modal-content p { font-size: 1.2rem; margin-bottom: 30px; color: var(--secondary-text); }
        .styled-button {
            padding: 14px 35px; font-size: 1rem; font-weight: 700; color: var(--background-dark);
            background: var(--accent-neon); border: 2px solid var(--accent-neon); border-radius: 50px;
            cursor: pointer; transition: all 0.3s ease; box-shadow: 0 0 15px var(--accent-shadow);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .styled-button:hover { transform: translateY(-5px); box-shadow: 0 0 25px var(--accent-glow); }

        /* --- Workshop UI --- */
        #workshop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .upgrade-card { background: var(--glass-bg); padding: 20px; border-radius: 15px; border: 1px solid var(--border-color); }
        .upgrade-card h3 { color: var(--accent-neon); margin-bottom: 10px; }
        .upgrade-card p { font-size: 0.9rem; margin-bottom: 15px; min-height: 40px; }
        .upgrade-card .level { font-family: 'Roboto Mono'; color: var(--secondary-text); }

        /* --- Power-ups Bar --- */
        #powerups-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 15px 0 0 0;
        }
        .powerup-btn {
            background: var(--glass-bg); border: 1px solid var(--border-color);
            width: 60px; height: 60px; border-radius: 50%;
            font-size: 1.5rem; color: var(--secondary-text); cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            position: relative;
        }
        .powerup-btn:hover { color: var(--accent-neon); border-color: var(--accent-neon); }
        .powerup-btn .count {
            position: absolute; top: 0; right: 0;
            background: var(--danger-color); color: white;
            border-radius: 50%; width: 20px; height: 20px;
            font-size: 0.8rem; font-weight: 700;
            display: flex; justify-content: center; align-items: center;
        }

        .hidden { display: none !important; }

    </style>
</head>
<body>
    <div id="game-container">
        <!-- Loading Overlay -->
        <div id="loading-overlay" class="modal-overlay">
            <div class="modal-content">
                <h2>Loading Chrono-Chai...</h2>
                <p>Calibrating time-stream... Please wait.</p>
            </div>
        </div>

        <!-- Start Screen Overlay -->
        <div id="start-screen" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Chrono-Chai</h2>
                <p>Welcome, Time-Traveling Chaiwala! History's greatest minds are thirsty. Serve them their favorite chai by answering questions from your syllabus.</p>
                <button id="start-game-btn" class="styled-button">Start Serving</button>
            </div>
        </div>

        <!-- Game Over Overlay -->
        <div id="game-over-screen" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Game Over!</h2>
                <p>Your final score is <span id="final-score" style="color: var(--accent-neon); font-weight: 700;">0</span>.</p>
                <p>You earned <span id="final-coins" style="color: var(--warning-color); font-weight: 700;">0</span> Chrono-Coins!</p>
                <button id="restart-game-btn" class="styled-button">Play Again</button>
                <a href="index.html" class="styled-button" style="margin-top: 15px; display: inline-block; background: transparent; color: var(--accent-neon);">Back to Hub</a>
            </div>
        </div>
        
        <!-- Workshop Modal -->
        <div id="workshop-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Stall Workshop</h2>
                <p>Use your Chrono-Coins to upgrade your equipment!</p>
                <div id="workshop-grid">
                    <div class="upgrade-card">
                        <h3>Kettle</h3>
                        <p>Reduce time between customers.</p>
                        <p class="level">Level: <span id="kettle-level">1</span></p>
                        <button class="styled-button" id="upgrade-kettle-btn">Upgrade (Cost: 50)</button>
                    </div>
                    <div class="upgrade-card">
                        <h3>Masala Box</h3>
                        <p>Add 0.5s to every timer.</p>
                        <p class="level">Level: <span id="masala-level">1</span></p>
                        <button class="styled-button" id="upgrade-masala-btn">Upgrade (Cost: 50)</button>
                    </div>
                </div>
                <button id="close-workshop-btn" class="styled-button" style="background: transparent; color: var(--accent-neon);">Close</button>
            </div>
        </div>

        <!-- Rewarded Ad Modal -->
        <div id="rewarded-ad-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h2>Get a Reward!</h2>
                <p>Watch a short ad to get a power-up.</p>
                <div id="reward-ad-container" style="width: 300px; height: 250px; background: #000; margin: 0 auto 20px auto;">
                    <!-- Ad 2 (Big Bar) will be loaded here -->
                </div>
                <p id="reward-ad-timer" style="font-family: 'Roboto Mono'; font-size: 1.2rem;">Ad will finish in 5s...</p>
            </div>
        </div>

        <!-- Main Game UI -->
        <header id="hud">
            <div class="hud-item">
                <span id="current-score">0</span>
                <p>Score</p>
            </div>
            <div class="hud-item">
                <span id="high-score">0</span>
                <p>High Score</p>
            </div>
            <div class="hud-item" id="player-lives">
                <i class="fas fa-heart"></i>
                <i class="fas fa-heart"></i>
                <i class="fas fa-heart"></i>
            </div>
            <div class="hud-item">
                <span id="chrono-coins">0</span>
                <p><i class="fas fa-coins"></i> Coins</p>
            </div>
            <div class="hud-item">
                <button id="open-workshop-btn" class="styled-button" style="padding: 8px 15px;"><i class="fas fa-wrench"></i></button>
            </div>
        </header>

        <main id="main-game-area">
            <div id="stall-area">
                <div style="text-align: center;">
                    <div id="customer-portrait" style="background-image: url('https://placehold.co/200x200/10162F/e0e0e0?text=?');"></div>
                    <h3 id="customer-name">Waiting for Customer...</h3>
                </div>
            </div>

            <div id="trivia-area">
                <div id="timer-bar"><div id="timer-progress"></div></div>
                <p id="question-text">The next historical figure will arrive shortly.</p>
                <div id="answer-options">
                    <button class="answer-btn" disabled>...</button>
                    <button class="answer-btn" disabled>...</button>
                    <button class="answer-btn" disabled>...</button>
                    <button class="answer-btn" disabled>...</button>
                </div>
            </div>

            <div id="powerups-bar">
                <button class="powerup-btn" id="powerup-slowmo-btn" title="Slow-Mo Sugar (Slows timer)">
                    <i class="fas fa-hourglass-half"></i>
                    <span class="count" id="slowmo-count">0</span>
                </button>
                <button class="powerup-btn" id="powerup-5050-btn" title="50/50 Milk (Removes 2 wrong answers)">
                    <i class="fas fa-star-half-alt"></i>
                    <span class="count" id="fiftyfifty-count">0</span>
                </button>
                <button class="powerup-btn" id="powerup-ad-btn" title="Watch Ad for a Power-up">
                    <i class="fas fa-gift"></i>
                </button>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const dom = {
                loadingOverlay: document.getElementById('loading-overlay'),
                startScreen: document.getElementById('start-screen'),
                gameOverScreen: document.getElementById('game-over-screen'),
                workshopModal: document.getElementById('workshop-modal'),
                rewardedAdModal: document.getElementById('rewarded-ad-modal'),
                hud: {
                    score: document.getElementById('current-score'),
                    highScore: document.getElementById('high-score'),
                    lives: document.getElementById('player-lives'),
                    coins: document.getElementById('chrono-coins'),
                },
                stall: {
                    portrait: document.getElementById('customer-portrait'),
                    name: document.getElementById('customer-name'),
                },
                trivia: {
                    timerProgress: document.getElementById('timer-progress'),
                    question: document.getElementById('question-text'),
                    options: document.getElementById('answer-options'),
                },
                powerups: {
                    slowmoBtn: document.getElementById('powerup-slowmo-btn'),
                    slowmoCount: document.getElementById('slowmo-count'),
                    fiftyfiftyBtn: document.getElementById('powerup-5050-btn'),
                    fiftyfiftyCount: document.getElementById('fiftyfifty-count'),
                    adBtn: document.getElementById('powerup-ad-btn'),
                },
                buttons: {
                    start: document.getElementById('start-game-btn'),
                    restart: document.getElementById('restart-game-btn'),
                    openWorkshop: document.getElementById('open-workshop-btn'),
                    closeWorkshop: document.getElementById('close-workshop-btn'),
                    upgradeKettle: document.getElementById('upgrade-kettle-btn'),
                    upgradeMasala: document.getElementById('upgrade-masala-btn'),
                },
                finalStats: {
                    score: document.getElementById('final-score'),
                    coins: document.getElementById('final-coins'),
                },
                workshopLevels: {
                    kettle: document.getElementById('kettle-level'),
                    masala: document.getElementById('masala-level'),
                }
            };

            // --- Game State & Config ---
            let fullQuestionBank = [];
            let userQuestionBank = [];
            let gameState = {};

            const initialGameState = {
                score: 0,
                lives: 3,
                coins: 0,
                highScore: 0,
                currentQuestion: null,
                timer: null,
                timerDuration: 15000, // 15 seconds
                isAnswerable: true,
                powerups: {
                    slowmo: 0,
                    fiftyfifty: 0,
                },
                upgrades: {
                    kettle: 1, // level
                    masala: 1, // level
                }
            };

            const upgradeCosts = {
                kettle: (level) => 50 * Math.pow(2, level - 1),
                masala: (level) => 50 * Math.pow(2, level - 1),
            };

            // --- Local Storage Keys ---
            const userInfoKey = 'sagarRajUserInfo';
            const gameSaveKey = 'chronoChaiSaveData';

            // --- Main Functions ---
            async function initializeGame() {
                loadGameState();
                try {
                    const response = await fetch('questions.json');
                    if (!response.ok) throw new Error('Network response was not ok');
                    fullQuestionBank = await response.json();
                    
                    const userInfo = JSON.parse(localStorage.getItem(userInfoKey));
                    const userClass = userInfo ? parseInt(userInfo.class) : 9; // Default to class 9
                    
                    userQuestionBank = fullQuestionBank.filter(q => q.class <= userClass);
                    
                    if (userQuestionBank.length === 0) {
                        alert("Could not find any questions for your class level. Defaulting to all questions.");
                        userQuestionBank = fullQuestionBank;
                    }

                    dom.loadingOverlay.classList.add('hidden');
                    dom.startScreen.classList.remove('hidden');
                } catch (error) {
                    console.error("Failed to load game questions:", error);
                    dom.loadingOverlay.innerHTML = `<div class="modal-content"><h2>Error</h2><p>Could not load game data. Please check your connection and refresh.</p></div>`;
                }
            }

            function startGame() {
                resetGameState();
                updateHUD();
                dom.startScreen.classList.add('hidden');
                dom.gameOverScreen.classList.add('hidden');
                nextTurn();
            }
            
            function nextTurn() {
                if (gameState.lives <= 0) {
                    gameOver();
                    return;
                }
                
                gameState.isAnswerable = true;
                const questionData = userQuestionBank[Math.floor(Math.random() * userQuestionBank.length)];
                gameState.currentQuestion = questionData;
                
                displayQuestion(questionData);
                startTimer();
            }

            function displayQuestion(q) {
                dom.stall.portrait.style.backgroundImage = `url('https://placehold.co/200x200/10162F/00ffff?text=${q.historical_figure.split(' ').join('+')}')`;
                dom.stall.name.textContent = q.historical_figure;
                dom.trivia.question.textContent = q.question;
                
                const optionsContainer = dom.trivia.options;
                optionsContainer.innerHTML = '';
                Object.entries(q.options).forEach(([key, value]) => {
                    const button = document.createElement('button');
                    button.classList.add('answer-btn');
                    button.dataset.answer = key;
                    button.textContent = `${key}: ${value}`;
                    button.onclick = () => handleAnswer(key);
                    optionsContainer.appendChild(button);
                });
            }

            function handleAnswer(selectedAnswerKey) {
                if (!gameState.isAnswerable) return;
                
                clearInterval(gameState.timer);
                gameState.isAnswerable = false;
                
                const correct = selectedAnswerKey === gameState.currentQuestion.correctAnswer;
                const buttons = dom.trivia.options.querySelectorAll('.answer-btn');
                
                buttons.forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.answer === gameState.currentQuestion.correctAnswer) {
                        btn.classList.add('correct');
                    } else if (btn.dataset.answer === selectedAnswerKey) {
                        btn.classList.add('wrong');
                    }
                });

                if (correct) {
                    gameState.score += 10;
                    gameState.coins += 1;
                    updateHUD();
                    setTimeout(nextTurn, 1500);
                } else {
                    gameState.lives--;
                    updateHUD();
                    const lifeIcons = dom.hud.lives.querySelectorAll('i');
                    if (lifeIcons[gameState.lives]) {
                        lifeIcons[gameState.lives].style.transform = 'scale(0)';
                    }
                    setTimeout(nextTurn, 2000);
                }
            }

            function startTimer() {
                const baseDuration = 15000; // 15 seconds
                const masalaBonus = (gameState.upgrades.masala - 1) * 500; // 0.5s per level
                gameState.timerDuration = baseDuration + masalaBonus;

                let timeRemaining = gameState.timerDuration;
                dom.trivia.timerProgress.style.transition = 'none';
                dom.trivia.timerProgress.style.width = '100%';
                
                setTimeout(() => {
                    dom.trivia.timerProgress.style.transition = `width ${gameState.timerDuration / 1000}s linear`;
                    dom.trivia.timerProgress.style.width = '0%';
                }, 50);

                gameState.timer = setInterval(() => {
                    timeRemaining -= 100;
                    if (timeRemaining <= 0) {
                        clearInterval(gameState.timer);
                        if(gameState.isAnswerable) handleAnswer(null); // Timeout is a wrong answer
                    }
                }, 100);
            }
            
            function gameOver() {
                clearInterval(gameState.timer);
                dom.finalStats.score.textContent = gameState.score;
                dom.finalStats.coins.textContent = gameState.coins;
                dom.gameOverScreen.classList.remove('hidden');

                if (gameState.score > gameState.highScore) {
                    gameState.highScore = gameState.score;
                }
                saveGameState();
            }

            // --- UI & State Updates ---
            function updateHUD() {
                dom.hud.score.textContent = gameState.score;
                dom.hud.highScore.textContent = gameState.highScore;
                dom.hud.coins.textContent = gameState.coins;
                dom.powerups.slowmoCount.textContent = gameState.powerups.slowmo;
                dom.powerups.fiftyfiftyCount.textContent = gameState.powerups.fiftyfifty;
            }

            function updateWorkshopUI() {
                dom.workshopLevels.kettle.textContent = gameState.upgrades.kettle;
                dom.workshopLevels.masala.textContent = gameState.upgrades.masala;
                dom.buttons.upgradeKettle.textContent = `Upgrade (Cost: ${upgradeCosts.kettle(gameState.upgrades.kettle)})`;
                dom.buttons.upgradeMasala.textContent = `Upgrade (Cost: ${upgradeCosts.masala(gameState.upgrades.masala)})`;
            }

            function resetGameState() {
                const savedData = JSON.parse(localStorage.getItem(gameSaveKey));
                gameState = {
                    ...initialGameState,
                    highScore: savedData ? savedData.highScore : 0,
                    coins: savedData ? savedData.coins : 0,
                    powerups: savedData ? savedData.powerups : initialGameState.powerups,
                    upgrades: savedData ? savedData.upgrades : initialGameState.upgrades,
                };
                const lifeIcons = dom.hud.lives.querySelectorAll('i');
                lifeIcons.forEach(icon => icon.style.transform = 'scale(1)');
            }

            function saveGameState() {
                const dataToSave = {
                    highScore: gameState.highScore,
                    coins: gameState.coins,
                    powerups: gameState.powerups,
                    upgrades: gameState.upgrades,
                };
                localStorage.setItem(gameSaveKey, JSON.stringify(dataToSave));
            }

            function loadGameState() {
                const savedData = JSON.parse(localStorage.getItem(gameSaveKey));
                if (savedData) {
                    gameState = { ...initialGameState, ...savedData };
                } else {
                    gameState = { ...initialGameState };
                }
                updateHUD();
                updateWorkshopUI();
            }

            // --- Power-up Logic ---
            function useSlowmo() {
                if (gameState.powerups.slowmo > 0 && gameState.isAnswerable) {
                    gameState.powerups.slowmo--;
                    clearInterval(gameState.timer);
                    // This is a simplified implementation. A full one would recalculate remaining time.
                    setTimeout(() => startTimer(), 5000); // Gives 5 extra seconds to think
                    updateHUD();
                    saveGameState();
                }
            }

            function useFiftyFifty() {
                if (gameState.powerups.fiftyfifty > 0 && gameState.isAnswerable) {
                    gameState.powerups.fiftyfifty--;
                    const correctAnswer = gameState.currentQuestion.correctAnswer;
                    const wrongAnswers = Object.keys(gameState.currentQuestion.options).filter(k => k !== correctAnswer);
                    const toDisable1 = wrongAnswers.splice(Math.floor(Math.random() * wrongAnswers.length), 1);
                    const toDisable2 = wrongAnswers.splice(Math.floor(Math.random() * wrongAnswers.length), 1);

                    dom.trivia.options.querySelectorAll('.answer-btn').forEach(btn => {
                        if (btn.dataset.answer === toDisable1[0] || btn.dataset.answer === toDisable2[0]) {
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                        }
                    });
                    updateHUD();
                    saveGameState();
                }
            }
            
            function showRewardedAd() {
                dom.rewardedAdModal.classList.remove('hidden');
                const adContainer = document.getElementById('reward-ad-container');
                const timerEl = document.getElementById('reward-ad-timer');
                
                // Load Ad 2 (Big Bar)
                adContainer.innerHTML = `<script type="text/javascript">
                    atOptions = { 'key' : 'de366f663355ebaa73712755e3876ab8', 'format' : 'iframe', 'height' : 250, 'width' : 300, 'params' : {} };
                <\/script>
                <script type="text/javascript" src="//www.highperformanceformat.com/de366f663355ebaa73712755e3876ab8/invoke.js"><\/script>`;

                let timeLeft = 5;
                timerEl.textContent = `Ad will finish in ${timeLeft}s...`;
                const adTimer = setInterval(() => {
                    timeLeft--;
                    timerEl.textContent = `Ad will finish in ${timeLeft}s...`;
                    if (timeLeft <= 0) {
                        clearInterval(adTimer);
                        dom.rewardedAdModal.classList.add('hidden');
                        // Grant a random reward
                        const randomReward = Math.random() > 0.5 ? 'slowmo' : 'fiftyfifty';
                        gameState.powerups[randomReward]++;
                        alert(`Reward! You received a ${randomReward === 'slowmo' ? 'Slow-Mo Sugar' : '50/50 Milk'} power-up!`);
                        updateHUD();
                        saveGameState();
                    }
                }, 1000);
            }


            // --- Event Listeners ---
            dom.buttons.start.onclick = startGame;
            dom.buttons.restart.onclick = startGame;
            dom.buttons.openWorkshop.onclick = () => {
                updateWorkshopUI();
                dom.workshopModal.classList.remove('hidden');
            };
            dom.buttons.closeWorkshop.onclick = () => dom.workshopModal.classList.add('hidden');
            
            dom.buttons.upgradeKettle.onclick = () => {
                const cost = upgradeCosts.kettle(gameState.upgrades.kettle);
                if (gameState.coins >= cost) {
                    gameState.coins -= cost;
                    gameState.upgrades.kettle++;
                    updateHUD();
                    updateWorkshopUI();
                    saveGameState();
                } else {
                    alert("Not enough Chrono-Coins!");
                }
            };

            dom.buttons.upgradeMasala.onclick = () => {
                const cost = upgradeCosts.masala(gameState.upgrades.masala);
                if (gameState.coins >= cost) {
                    gameState.coins -= cost;
                    gameState.upgrades.masala++;
                    updateHUD();
                    updateWorkshopUI();
                    saveGameState();
                } else {
                    alert("Not enough Chrono-Coins!");
                }
            };
            
            dom.powerups.slowmoBtn.onclick = useSlowmo;
            dom.powerups.fiftyfiftyBtn.onclick = useFiftyFifty;
            dom.powerups.adBtn.onclick = showRewardedAd;

            // --- Initial Load ---
            initializeGame();
        });
    </script>
</body>
</html>
