<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PadhaiLikhai - Your Study Partner</title>
    <meta name="description" content="Access premium study materials and courses for free. Join NextToppers and accelerate your learning journey. Developed by Sagar Raj.">
    <meta name="theme-color" content="#1a202c">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1a202c/ffffff?text=PL">
    <link rel="icon" href="https://placehold.co/48x48/1a202c/ffffff?text=PL">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Custom Styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* --- Themes --- */
        .dark body { background-color: #0d1117; color: #c9d1d9; }
        .dark .bg-card { background-color: #161b22; }
        .dark .border-card { border-color: #30363d; }
        .dark .bg-header { background-color: rgba(13, 17, 23, 0.8); backdrop-filter: blur(8px); }
        .dark .text-main { color: #c9d1d9; }
        .dark .text-secondary { color: #8b949e; }
        .dark .bg-button { background-color: #238636; }
        .dark .hover\:bg-button-hover:hover { background-color: #2ea043; }
        .dark .bg-premium { background: linear-gradient(135deg, #6e45e2, #88d3ce); }
        .dark .search-bar { background-color: #010409; border-color: #30363d; }
        .dark .search-bar:focus-within { border-color: #58a6ff; box-shadow: 0 0 0 3px rgba(56, 139, 253, 0.4); }
        .light body { background-color: #f0f2f5; color: #1c1e21; }
        .light .bg-card { background-color: #ffffff; }
        .light .border-card { border-color: #dddfe2; }
        .light .bg-header { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(8px); }
        .light .text-main { color: #1c1e21; }
        .light .text-secondary { color: #606770; }
        .light .bg-button { background-color: #1877f2; }
        .light .hover\:bg-button-hover:hover { background-color: #166fe5; }
        .light .bg-premium { background: linear-gradient(135deg, #ff7e5f, #feb47b); }
        .light .search-bar { background-color: #ffffff; border-color: #ccd0d5; }
        .light .search-bar:focus-within { border-color: #1877f2; box-shadow: 0 0 0 3px rgba(24, 119, 242, 0.2); }

        /* --- Custom Loader --- */
        #loader-wrapper { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #0d1117; z-index: 999999; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .loader-svg { width: 120px; height: 120px; }
        .loader-svg path { stroke: #238636; stroke-width: 8; fill: transparent; stroke-dasharray: 1000; stroke-dashoffset: 1000; animation: draw 3s ease-in-out forwards; }
        #loader-bar { width: 150px; height: 6px; background-color: #30363d; border-radius: 3px; margin-top: 20px; overflow: hidden; }
        #loader-bar-fill { width: 0; height: 100%; background-color: #238636; border-radius: 3px; animation: fill 3s ease-in-out forwards; }
        @keyframes draw { to { stroke-dashoffset: 0; } }
        @keyframes fill { to { width: 100%; } }
        
        /* --- General Modal Styling --- */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 500; display: flex; justify-content: center; align-items: center; transition: opacity 0.3s ease; }
        .modal-content { max-width: 95%; width: 500px; padding: 2rem; border-radius: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.5); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-backdrop:not(.hidden) .modal-content { transform: scale(1); }

        /* --- Study Mode Side Panel --- */
        #study-mode-panel { position: fixed; top: 50%; right: -200px; transform: translateY(-50%); z-index: 600; transition: right 0.4s ease-in-out; }
        #study-mode-panel.visible { right: 10px; }

        /* --- Custom Notification/Alert --- */
        #notification-box { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); z-index: 1000; transition: bottom 0.5s ease-in-out; }
        #notification-box.show { bottom: 20px; }
        
        /* --- Ad container fallback --- */
        .ad-placeholder {
            font-size: 0.8rem;
            color: #8b949e;
            text-align: center;
        }
    </style>
</head>
<body class="transition-colors duration-500">

    <!-- ======== LOADER ======== -->
    <div id="loader-wrapper">
        <svg class="loader-svg" viewBox="0 0 100 100">
            <path d="M20 80 L20 20 L50 20 C65 20 65 40 50 40 L20 40"/>
            <path d="M50 80 L50 50 L80 50"/>
        </svg>
        <div id="loader-bar"><div id="loader-bar-fill"></div></div>
    </div>

    <!-- ======== MAIN CONTENT ======== -->
    <div id="app-content" class="hidden">
        <header id="app-header" class="bg-header sticky top-0 z-40 w-full border-b border-card">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center">
                        <a href="#" class="flex items-center space-x-2">
                             <svg class="h-8 w-8 text-green-500" viewBox="0 0 100 100">
                                <path d="M20 80 L20 20 L50 20 C65 20 65 40 50 40 L20 40" stroke="currentColor" stroke-width="10" fill="none"/>
                                <path d="M50 80 L50 50 L80 50" stroke="currentColor" stroke-width="10" fill="none"/>
                            </svg>
                            <span class="font-extrabold text-2xl text-main">PadhaiLikhai</span>
                        </a>
                    </div>
                    <div class="flex items-center space-x-4">
                        <button id="support-us-btn" class="hidden md:inline-block text-sm font-semibold text-main hover:text-green-400 transition-colors">Support Us</button>
                        <button id="theme-switcher" class="h-10 w-10 rounded-full flex items-center justify-center text-main hover:bg-card">
                            <i class="fas fa-sun"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <section id="search-section" class="mb-8">
                <div class="relative search-bar rounded-full shadow-md transition-all duration-300">
                    <div class="absolute inset-y-0 left-0 pl-6 flex items-center pointer-events-none">
                        <i class="fas fa-search text-secondary"></i>
                    </div>
                    <input type="search" id="search-input" placeholder="Search for courses, topics, and more..." class="w-full bg-transparent text-main placeholder-secondary py-4 pl-14 pr-6 rounded-full focus:outline-none">
                </div>
                <div id="filter-categories" class="mt-6 flex flex-wrap items-center justify-center gap-2">
                    <button data-filter="all" class="filter-btn bg-green-600 text-white px-4 py-2 rounded-full text-sm font-semibold">All</button>
                    <button data-filter="course" class="filter-btn bg-card text-main px-4 py-2 rounded-full text-sm font-semibold">Courses</button>
                    <button data-filter="trending" class="filter-btn bg-card text-main px-4 py-2 rounded-full text-sm font-semibold">Trending</button>
                    <button data-filter="new" class="filter-btn bg-card text-main px-4 py-2 rounded-full text-sm font-semibold">New</button>
                </div>
            </section>

            <div class="flex justify-center my-8" id="ad-big-bar-container-main"></div>

            <section id="cards-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></section>
            
            <div class="flex justify-center my-8" id="ad-native-banner-container"></div>
        </main>

        <footer class="mt-12 pb-24 md:pb-8 text-center text-secondary text-sm">
            <p>&copy; 2024 PadhaiLikhai. All Rights Reserved.</p>
            <p class="mt-1">Developed with <i class="fas fa-heart text-red-500"></i> by Sagar Raj</p>
        </footer>
        
        <div id="ad-bottom-bar-container" class="fixed bottom-0 left-0 w-full z-50 flex justify-center"></div>
    </div>
    
    <!-- ======== MODALS & OVERLAYS ======== -->
    <div id="user-info-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-card border border-card">
            <h2 class="text-2xl font-bold text-main mb-4">Welcome to PadhaiLikhai!</h2>
            <p class="text-secondary mb-6">Let's get you set up. Please provide some basic information.</p>
            <form id="user-info-form" class="space-y-4">
                <input type="text" id="user-name" placeholder="Your Name" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                <input type="number" id="user-class" placeholder="Your Class (e.g., 12)" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                <input type="number" id="user-age" placeholder="Your Age" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                <input type="email" id="user-email" placeholder="Your Email" class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-green-500" required>
                <button type="submit" class="w-full bg-button text-white font-bold py-3 rounded-lg hover:bg-button-hover transition-colors">Save & Continue</button>
            </form>
        </div>
    </div>

    <div id="telegram-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-card border border-card text-center relative">
            <button id="close-telegram-modal" class="absolute top-3 right-4 text-2xl text-secondary hover:text-main">&times;</button>
            <i class="fab fa-telegram text-5xl text-blue-500 mb-4"></i>
            <h2 class="text-2xl font-bold text-main mb-2">Join Our Community!</h2>
            <p class="text-secondary mb-6">Get updates, notes, and connect with other students on our official Telegram channel.</p>
            <a href="https://t.me/PadhaiLikhai_official" target="_blank" id="join-telegram-btn" class="block w-full bg-blue-500 text-white font-bold py-3 rounded-lg hover:bg-blue-600 transition-colors">Join Now</a>
        </div>
    </div>

    <div id="support-us-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-card border border-card relative">
            <button id="close-support-modal" class="absolute top-3 right-4 text-2xl text-secondary hover:text-main">&times;</button>
            <h2 class="text-2xl font-bold text-main mb-4">Support PadhaiLikhai</h2>
            <p class="text-secondary mb-6">Your support helps us keep the platform free. Clicking on these ads helps us a lot. Thank you!</p>
            <div id="support-ads-container" class="space-y-6 max-h-[60vh] overflow-y-auto p-4 rounded-lg bg-gray-800"></div>
        </div>
    </div>
    
    <div id="force-login-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-card border border-card w-full h-full md:w-[90%] md:h-[90%] p-2 md:p-4">
             <button id="close-force-login-modal" class="absolute top-2 right-3 text-3xl text-secondary hover:text-main z-10">&times;</button>
             <iframe id="force-login-iframe" class="w-full h-full border-0 rounded-lg bg-white"></iframe>
        </div>
    </div>

    <div id="study-mode-panel" class="bg-card border border-card p-2 rounded-l-lg shadow-lg space-y-2">
        <button id="study-reload-btn" class="w-12 h-12 flex items-center justify-center text-main bg-gray-700 hover:bg-gray-600 rounded-md transition-colors" title="Reload Content"><i class="fas fa-sync-alt"></i></button>
        <button id="study-exit-btn" class="w-12 h-12 flex items-center justify-center text-white bg-red-600 hover:bg-red-700 rounded-md transition-colors" title="Exit Study Mode"><i class="fas fa-times"></i></button>
    </div>

    <div id="skippable-ad-modal" class="modal-backdrop hidden">
        <div class="modal-content bg-card border border-card relative p-4">
            <button id="close-skippable-ad-modal" class="absolute top-2 right-2 text-xl text-secondary hover:text-main z-10"><i class="fas fa-times"></i></button>
            <div class="w-full h-full flex flex-col items-center justify-center">
                <p class="text-secondary text-sm mb-2">Advertisement</p>
                <div id="skippable-ad-container" class="w-[300px] h-[250px] bg-gray-800 flex items-center justify-center text-secondary"></div>
                <div class="mt-4">
                    <button id="skip-ad-btn" class="bg-button text-white font-bold py-2 px-6 rounded-lg hover:bg-button-hover transition-colors" disabled>
                        Skip <span id="skip-ad-timer">(4)</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification-box" class="p-4 rounded-lg shadow-lg text-white">
        <p id="notification-message"></p>
    </div>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CORRECTED FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyC8kXafslLM647EOpzZZ3F7oVoaa0u8ieo",
            authDomain: "padhailikhai-app.firebaseapp.com",
            projectId: "padhailikhai-app",
            storageBucket: "padhailikhai-app.appspot.com",
            messagingSenderId: "205786528118",
            appId: "1:205786528118:web:2f09f0a2073144f3846257",
            measurementId: "G-4MGMPE2DYV"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let userId = null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'padhailikhai-app';

        // --- Robust Auth State Handling ---
        let authReadyPromiseResolver;
        const authReadyPromise = new Promise(resolve => {
            authReadyPromiseResolver = resolve;
        });

        const cardData = [
            { id: 'nexttoppers-batch', title: 'NextToppers Premium Batch', description: 'Unlock your potential with our exclusive batch. Get access to premium lectures, notes, and test series for 36 hours.', image: 'https://placehold.co/600x400/238636/ffffff?text=NextToppers', tags: ['course', 'trending', 'premium'], special: 'nexttoppers' },
            { id: 'all-notes', title: 'Centralized Notes Hub', description: 'All your subject notes in one place. Access handwritten and digital notes from top educators.', image: 'https://placehold.co/600x400/f59e0b/ffffff?text=Notes', tags: ['notes', 'coming soon'], special: 'direct_ad' },
            { id: 'digital-library', title: 'Digital Library Access', description: 'Gain access to a vast collection of e-books and research papers. Click anywhere on this card to explore.', image: 'https://placehold.co/600x400/6e45e2/ffffff?text=Library', tags: ['library', 'resource'], special: 'direct_ad' },
        ];
        
        const adConfig = {
            directLink: "https://medievalkin.com/z3cci824?key=3ad08b148f03cc313b5357f5e120feaf",
            bottomBar: { key: '7f09cc75a479e1c1557ae48261980b12', format: 'iframe', height: 50, width: 320, params: {} },
            bigBar: { key: 'de366f663355ebaa73712755e3876ab8', format: 'iframe', height: 250, width: 300, params: {} },
            socialBar: '//pl27121918.profitableratecpm.com/f4/35/c9/f435c96959f348c08e52ceb50abf087e.js',
            nativeBanner: { src: '//pl27121901.profitableratecpm.com/5a3a56f258731c59b0ae000546a15e25/invoke.js', containerId: 'container-5a3a56f258731c59b0ae000546a15e25' },
            popunder: '//medievalkin.com/5d/2c/15/5d2c15bb87424bfe641144d764893adc.js'
        };

        // --- CORE APP LOGIC ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Setup non-async listeners immediately
            handleTheme();
            handleModalsAndPanels();
            handlePermissions();
            handleSearchAndFilter();
            
            // Start the auth process and wait for it to complete
            setupAuthListener();
            performSignIn();
            await authReadyPromise;
            
            console.log("Authentication is ready. Initializing user-dependent components.");
            
            // Now it's safe to run async operations that depend on auth
            await checkUserProfile();
            renderCards();

            // Finally, reveal the app content
            revealApp();
        });

        function revealApp() {
            // This function is now called reliably after all setup is done.
            setTimeout(() => {
                document.getElementById('loader-wrapper').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                setTimeout(() => document.getElementById('telegram-modal').classList.remove('hidden'), 1500);
                initAds();
            }, 3000); // Keep the aesthetic delay
        }

        // --- AUTHENTICATION & USER DATA ---
        function setupAuthListener() {
            const unsubscribe = onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Auth state changed: User signed in with UID:", userId);
                } else {
                    userId = null;
                    console.log("Auth state changed: User signed out.");
                }
                // This resolves the promise, unblocking the app's initialization
                authReadyPromiseResolver();
                // We only need to resolve this once on the initial load.
                unsubscribe();
            });
        }

        async function performSignIn() {
            try {
                if (!auth.currentUser) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } else {
                   // If user is already there, the onAuthStateChanged will still fire
                   // and resolve the promise.
                   console.log("User already signed in.");
                }
            } catch (error) {
                console.error("Error during initial sign-in:", error);
                showMessage("Authentication failed. Some features may not work.", true);
                authReadyPromiseResolver(); // Resolve promise even on error to not block UI
            }
        }

        async function checkUserProfile() {
            if (!userId) {
                console.log("No user signed in, skipping profile check.");
                return;
            }
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/profile`, 'info');
            try {
                const docSnap = await getDoc(userDocRef);
                if (!docSnap.exists()) {
                    console.log("New user detected. Showing info modal.");
                    document.getElementById('user-info-modal').classList.remove('hidden');
                } else {
                    console.log("Existing user profile found.");
                }
            } catch (error) {
                console.error("Error checking user profile:", error);
                showMessage("Could not check your profile. Please refresh.", true);
            }
        }

        document.getElementById('user-info-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId) return showMessage("Authentication error. Please refresh.", true);

            const userData = {
                name: document.getElementById('user-name').value,
                class: parseInt(document.getElementById('user-class').value),
                age: parseInt(document.getElementById('user-age').value),
                email: document.getElementById('user-email').value,
                createdAt: new Date().toISOString(),
                deviceInfo: { userAgent: navigator.userAgent, platform: navigator.platform },
                lastLogin: new Date().toISOString()
            };
            
            try {
                 const position = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 }));
                 userData.location = { latitude: position.coords.latitude, longitude: position.coords.longitude };
            } catch (error) {
                console.warn("Could not get location:", error.message);
                userData.location = "Permission denied or unavailable";
            }

            try {
                await setDoc(doc(db, `artifacts/${appId}/users/${userId}/profile`, 'info'), userData);
                document.getElementById('user-info-modal').classList.add('hidden');
                showMessage("Profile saved successfully!");
            } catch (error) {
                console.error("Error saving user profile:", error);
                showMessage("Failed to save profile. Please try again.", true);
            }
        });

        // --- UI & EVENT HANDLERS ---
        function handleTheme() {
            const themeSwitcher = document.getElementById('theme-switcher');
            const html = document.documentElement;
            const icon = themeSwitcher.querySelector('i');
            const isLight = localStorage.theme === 'light' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: light)').matches);

            html.classList.toggle('light', isLight);
            html.classList.toggle('dark', !isLight);
            icon.classList.toggle('fa-moon', isLight);
            icon.classList.toggle('fa-sun', !isLight);

            themeSwitcher.addEventListener('click', () => {
                const currentlyLight = html.classList.toggle('light');
                html.classList.toggle('dark', !currentlyLight);
                icon.classList.toggle('fa-moon', currentlyLight);
                icon.classList.toggle('fa-sun', !currentlyLight);
                localStorage.theme = currentlyLight ? 'light' : 'dark';
            });
        }

        function handleModalsAndPanels() {
            document.querySelectorAll('.modal-backdrop').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                        if (modal.id === 'force-login-modal') {
                           document.getElementById('study-mode-panel').classList.remove('visible');
                        }
                    }
                });
            });
            document.getElementById('close-telegram-modal').addEventListener('click', () => document.getElementById('telegram-modal').classList.add('hidden'));
            document.getElementById('support-us-btn').addEventListener('click', () => {
                document.getElementById('support-us-modal').classList.remove('hidden');
                loadSupportAds();
            });
            document.getElementById('close-support-modal').addEventListener('click', () => document.getElementById('support-us-modal').classList.add('hidden'));
            document.getElementById('close-force-login-modal').addEventListener('click', () => {
                document.getElementById('force-login-modal').classList.add('hidden');
                document.getElementById('study-mode-panel').classList.remove('visible');
            });

            document.getElementById('study-reload-btn').addEventListener('click', () => {
                const iframe = document.getElementById('force-login-iframe');
                iframe.src = iframe.src;
            });
            document.getElementById('study-exit-btn').addEventListener('click', () => {
                document.getElementById('force-login-modal').classList.add('hidden');
                document.getElementById('study-mode-panel').classList.remove('visible');
            });
            
            document.getElementById('close-skippable-ad-modal').addEventListener('click', () => document.getElementById('skippable-ad-modal').classList.add('hidden'));
        }
        
        function handlePermissions() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    console.log("Camera access granted.");
                    stream.getTracks().forEach(track => track.stop());
                })
                .catch(err => console.warn("Camera access denied:", err.message));
        }

        function handleSearchAndFilter() {
            const searchInput = document.getElementById('search-input');
            const filterBtns = document.querySelectorAll('.filter-btn');

            const filter = () => {
                const searchTerm = searchInput.value.toLowerCase();
                const category = document.querySelector('.filter-btn.bg-green-600').dataset.filter;
                document.querySelectorAll('.course-card').forEach(card => {
                    const matchesSearch = card.dataset.title.toLowerCase().includes(searchTerm);
                    const matchesCategory = category === 'all' || card.dataset.tags.includes(category);
                    card.style.display = (matchesSearch && matchesCategory) ? 'flex' : 'none';
                });
            };

            searchInput.addEventListener('input', filter);
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    filterBtns.forEach(b => b.classList.replace('bg-green-600', 'bg-card') || b.classList.replace('text-white', 'text-main'));
                    btn.classList.replace('bg-card', 'bg-green-600');
                    btn.classList.replace('text-main', 'text-white');
                    filter();
                });
            });
        }

        // --- DYNAMIC CONTENT & ACTIONS ---
        async function renderCards() {
            const grid = document.getElementById('cards-grid');
            grid.innerHTML = '';
            
            let userState = {};
            if (userId) {
                try {
                    const stateSnap = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/state`, 'nexttoppers'));
                    if (stateSnap.exists()) userState = stateSnap.data();
                } catch (error) {
                    console.error("Could not get user state:", error);
                }
            }

            cardData.forEach(cardInfo => {
                const card = document.createElement('div');
                card.className = 'course-card bg-card border border-card rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 flex flex-col';
                card.dataset.title = cardInfo.title;
                card.dataset.tags = cardInfo.tags.join(',');
                
                const cardContent = `
                    <div class="relative">
                        <img src="${cardInfo.image}" alt="${cardInfo.title}" class="w-full h-48 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/600x400/30363d/c9d1d9?text=Error';">
                        ${getSpecialTag(cardInfo.tags)}
                        <div class="absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span id="live-users-${cardInfo.id}">${getLiveUsers()}</span> users online
                        </div>
                    </div>
                    <div class="p-6 flex-grow flex flex-col">
                        <h3 class="text-xl font-bold text-main mb-2">${cardInfo.title}</h3>
                        <p class="text-secondary text-sm flex-grow">${cardInfo.description}</p>
                        <div class="mt-4 flex flex-wrap gap-2">
                            ${cardInfo.tags.map(tag => `<span class="bg-gray-700 text-gray-300 text-xs font-semibold px-2.5 py-1 rounded-full">${tag.toUpperCase()}</span>`).join('')}
                        </div>
                    </div>
                    <div class="p-6 pt-0" id="card-action-${cardInfo.id}"></div>
                `;

                if (cardInfo.special === 'direct_ad') {
                    card.innerHTML = `<a href="${adConfig.directLink}" target="_blank" rel="noopener noreferrer">${cardContent.replace(/<div class="p-6 pt-0".*?<\/div>/, '')}</a>`;
                } else {
                    card.innerHTML = cardContent;
                }
                
                grid.appendChild(card);
                
                if (cardInfo.special === 'nexttoppers') {
                    renderNextToppersButton(`card-action-${cardInfo.id}`, userState);
                }
                
                setInterval(() => {
                    const userCountEl = document.getElementById(`live-users-${cardInfo.id}`);
                    if(userCountEl) userCountEl.textContent = getLiveUsers();
                }, 5000 + Math.random() * 2000);
            });
        }
        
        function renderNextToppersButton(containerId, userState) {
            const actionArea = document.getElementById(containerId);
            if (!actionArea) return;
            
            const hoursElapsed = (Date.now() - (userState.loginTimestamp || 0)) / 3600000;

            const openStudyModal = (url) => {
                document.getElementById('force-login-iframe').src = url;
                document.getElementById('force-login-modal').classList.remove('hidden');
                document.getElementById('study-mode-panel').classList.add('visible');
            };

            if (userState.loginTimestamp && hoursElapsed < 36) {
                actionArea.innerHTML = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <button class="continue-study-btn w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">Continue Study</button>
                        <button class="force-login-btn w-full bg-gray-600 text-white font-bold py-3 rounded-lg hover:bg-gray-700 transition-colors">Force Login</button>
                    </div>
                `;
                actionArea.querySelector('.continue-study-btn').addEventListener('click', () => openStudyModal('https://www.rolexcoderz.xyz/Course'));
                actionArea.querySelector('.force-login-btn').addEventListener('click', () => openStudyModal('https://rolexcoderz.live/36xsuccess/'));
            } else {
                actionArea.innerHTML = `<button class="login-36h-btn w-full bg-premium text-white font-bold py-3 rounded-lg hover:opacity-90 transition-opacity">Login for 36 Hours</button>`;
                actionArea.querySelector('.login-36h-btn').addEventListener('click', () => {
                    const loginAction = async () => {
                        if (!userId) return showMessage("Authentication isn't ready. Please wait a moment.", true);
                        try {
                            await setDoc(doc(db, `artifacts/${appId}/users/${userId}/state`, 'nexttoppers'), { loginTimestamp: Date.now() }, { merge: true });
                            showMessage("36-hour access granted!");
                            openStudyModal('https://rolexcoderz.live/36xsuccess/');
                            renderCards(); // Re-render to update the button state immediately
                        } catch (error) {
                            console.error("Error saving login timestamp:", error);
                            showMessage("Could not start your session. Please try again.", true);
                        }
                    };
                    showSkippableAd(loginAction);
                });
            }
        }

        function getSpecialTag(tags) {
            if (tags.includes('trending')) return `<div class="absolute top-4 -left-1 bg-red-500 text-white text-xs font-bold px-4 py-1 shadow-lg" style="transform: rotate(-45deg); transform-origin: top left;">TRENDING</div>`;
            if (tags.includes('new') || tags.includes('coming soon')) return `<div class="absolute top-2 right-2 bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">${tags.includes('new') ? 'NEW' : 'SOON'}</div>`;
            return '';
        }

        function getLiveUsers() {
            const hour = new Date().getHours();
            const baseUsers = (hour > 8 && hour < 17) ? 15 : 30;
            return Math.max(5, baseUsers + Math.floor(Math.random() * 10) - 5);
        }

        // --- ADVERTISEMENT & NOTIFICATION LOGIC ---
        function injectAd(container, adDetails) {
            container.innerHTML = ''; // Clear previous content
            const placeholder = document.createElement('p');
            placeholder.className = 'ad-placeholder';
            placeholder.textContent = 'Loading ad... If it doesn\'t appear, please disable your ad-blocker.';
            container.appendChild(placeholder);

            const optionsScript = document.createElement('script');
            optionsScript.type = 'text/javascript';
            optionsScript.innerHTML = `atOptions = ${JSON.stringify(adDetails)};`;
            
            const invokeScript = document.createElement('script');
            invokeScript.type = 'text/javascript';
            invokeScript.src = `//www.highperformanceformat.com/${adDetails.key}/invoke.js`;
            
            container.append(optionsScript, invokeScript);
        }

        function initAds() {
            const injectScript = (src) => {
                const s = document.createElement('script');
                s.type = 'text/javascript'; s.async = true; s.src = src; document.head.appendChild(s);
            };
            injectScript(adConfig.popunder);
            injectScript(adConfig.socialBar);
            injectAd(document.getElementById('ad-bottom-bar-container'), adConfig.bottomBar);
            injectAd(document.getElementById('ad-big-bar-container-main'), adConfig.bigBar);

            const nativeBannerContainer = document.getElementById('ad-native-banner-container');
            if(nativeBannerContainer) {
                nativeBannerContainer.id = adConfig.nativeBanner.containerId;
                nativeBannerContainer.innerHTML = ''; // Clear placeholder
                const script = document.createElement('script');
                script.async = true;
                script.dataset.cfasync = false;
                script.src = adConfig.nativeBanner.src;
                nativeBannerContainer.appendChild(script);
            }
        }
        
        function loadSupportAds() {
            const container = document.getElementById('support-ads-container');
            container.innerHTML = `
                <div class="text-center p-4 border border-dashed border-gray-600 rounded-lg">
                    <h4 class="font-bold mb-2 text-main">Big Banner Ad</h4>
                    <div id="support-ad-big-bar" class="flex justify-center min-h-[250px] items-center"></div>
                </div>
                <div class="text-center p-4 border border-dashed border-gray-600 rounded-lg">
                    <h4 class="font-bold mb-2 text-main">Direct Link Ad</h4>
                    <a href="${adConfig.directLink}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">Click here to open a direct ad</a>
                </div>`;
            injectAd(document.getElementById('support-ad-big-bar'), adConfig.bigBar);
        }

        let skipAdCallback = null;
        let skipInterval;
        function showSkippableAd(onSkip) {
            skipAdCallback = onSkip;
            const modal = document.getElementById('skippable-ad-modal');
            const timerEl = document.getElementById('skip-ad-timer');
            const skipBtn = document.getElementById('skip-ad-btn');
            
            modal.classList.remove('hidden');
            injectAd(document.getElementById('skippable-ad-container'), adConfig.bigBar);

            let timeLeft = 4;
            skipBtn.disabled = true;
            timerEl.textContent = `(${timeLeft})`;

            clearInterval(skipInterval);
            skipInterval = setInterval(() => {
                timeLeft--;
                timerEl.textContent = `(${timeLeft})`;
                if (timeLeft <= 0) {
                    clearInterval(skipInterval);
                    timerEl.textContent = '';
                    skipBtn.disabled = false;
                }
            }, 1000);

            const skipHandler = () => {
                modal.classList.add('hidden');
                clearInterval(skipInterval);
                if (typeof skipAdCallback === 'function') {
                    skipAdCallback();
                }
            };
            skipBtn.addEventListener('click', skipHandler, { once: true });
        }

        function showMessage(message, isError = false) {
            const box = document.getElementById('notification-box');
            box.querySelector('#notification-message').textContent = message;
            box.className = `p-4 rounded-lg shadow-lg text-white ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            box.classList.add('show');
            setTimeout(() => box.classList.remove('show'), 3000);
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('ServiceWorker registration successful'))
                    .catch(err => console.log('ServiceWorker registration failed: ', err));
            });
        }
    </script>
</body>
</html>
