<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PadhaiLikhai — Study Partner</title>
  <meta name="theme-color" content="#1a202c" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="icon" href="/icon-192.png" />
  <link rel="apple-touch-icon" href="/icon-192.png" />

  <!-- Tailwind CDN (dev) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    :root { --accent: #238636; }
    body { font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; padding-bottom: 84px; }
    .dark body{ background:#0d1117; color:#c9d1d9; }
    .bg-card { background:#161b22; }
    .border-card { border-color:#30363d; }
    .bg-header { background: rgba(13,17,23,.8); backdrop-filter: blur(8px); }
    .text-main { color:#c9d1d9; }
    .text-secondary { color:#8b949e; }
    .bg-button { background: var(--accent); }
    .hover\:bg-button-hover:hover { background:#2ea043; }

    /* Loader */
    #loader-wrapper{ position:fixed; inset:0; background:#0d1117; z-index:99999; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:18px; }
    .pl-svg{ width:240px; height:90px; }
    .pl-char{ font-weight:800; font-size:56px; fill:none; stroke: url(#g); stroke-width:1.6; stroke-dasharray:260; stroke-dashoffset:260; animation:draw 1.6s forwards; }
    .pl-progress{ width:300px; height:8px; background:#30363d; border-radius:999px; overflow:hidden; }
    .pl-progress-fill{ height:100%; width:0; background:linear-gradient(90deg,#238636,#6e45e2); animation:plfill 1.6s forwards; }
    @keyframes draw{ to { stroke-dashoffset: 0; } } @keyframes plfill { to { width: 100%; } }

    /* UI */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:500; display:flex; align-items:center; justify-content:center; padding:20px; }
    .modal-content{ max-width:96%; width:720px; padding:18px; border-radius:12px; }
    #notification-box{ position:fixed; left:50%; transform:translateX(-50%); bottom:-140px; z-index:1001; transition:bottom .4s; }
    #notification-box.show{ bottom:100px; }
    .iframe-wrap{ position:relative; width:100%; padding-top:56.25%; border-radius:8px; overflow:hidden; background:#000; }
    .iframe-wrap iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; }

    /* responsive tweaks */
    @media (max-width:768px){ .pl-svg{ width:180px; height:70px; } .modal-content{ width:95%; } }

    .ad-placeholder { font-size:.85rem; color:#8b949e; text-align:center; padding:6px 8px; }
  </style>
</head>
<body class="transition-colors duration-500">

  <!-- Loader -->
  <div id="loader-wrapper" aria-hidden="true">
    <svg class="pl-svg" viewBox="0 0 300 90" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="P L loader">
      <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0%" stop-color="#238636"/><stop offset="100%" stop-color="#6e45e2"/></linearGradient></defs>
      <text x="20" y="58" class="pl-char" style="font-family:Inter, sans-serif;">P</text>
      <text x="96" y="58" class="pl-char" style="font-family:Inter, sans-serif; animation-delay:.15s">L</text>
      <text x="160" y="58" fill="#c9d1d9" font-size="18">PadhaiLikhai</text>
    </svg>
    <div class="pl-progress"><div class="pl-progress-fill"></div></div>
  </div>

  <!-- App -->
  <div id="app-content" class="hidden">
    <header id="app-header" class="bg-header sticky top-0 z-40 w-full border-b border-card">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center space-x-3">
            <a href="#" class="flex items-center gap-2">
              <svg class="h-8 w-8 text-green-500" viewBox="0 0 100 100"><path d="M20 80 L20 20 L50 20 C65 20 65 40 50 40 L20 40" stroke="currentColor" stroke-width="10" fill="none"/><path d="M50 80 L50 50 L80 50" stroke="currentColor" stroke-width="10" fill="none"/></svg>
              <span class="font-extrabold text-2xl text-main">PadhaiLikhai</span>
            </a>
          </div>
          <div class="flex items-center gap-2">
            <button id="support-us-btn" class="hidden md:inline-block text-sm font-semibold text-main hover:text-green-400 px-2">Support Us</button>
            <button id="settings-btn" class="h-10 w-10 rounded-full flex items-center justify-center text-main hover:bg-card" title="Settings"><i class="fas fa-cog"></i></button>
            <button id="theme-switcher" class="h-10 w-10 rounded-full flex items-center justify-center text-main hover:bg-card" title="Toggle Theme"><i class="fas fa-sun"></i></button>
            <div id="auth-area" class="ml-2 flex items-center gap-2"></div>
          </div>
        </div>
      </div>
    </header>

    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <section id="search-section" class="mb-8">
        <div class="relative search-bar rounded-full shadow-md transition-all duration-300">
          <div class="absolute inset-y-0 left-0 pl-6 flex items-center pointer-events-none"><i class="fas fa-search text-secondary"></i></div>
          <input type="search" id="search-input" placeholder="Search for courses, topics, and more..." class="w-full bg-transparent text-main placeholder-secondary py-4 pl-14 pr-6 rounded-full focus:outline-none" />
        </div>

        <div id="filter-categories" class="mt-6 flex flex-wrap items-center justify-center gap-2">
          <button data-filter="all" class="filter-btn bg-green-600 text-white px-4 py-2 rounded-full text-sm font-semibold">All</button>
          <button data-filter="course" class="filter-btn bg-card text-main px-4 py-2 rounded-full text-sm font-semibold">Courses</button>
          <button data-filter="trending" class="filter-btn bg-card text-main px-4 py-2 rounded-full text-sm font-semibold">Trending</button>
          <button data-filter="new" class="filter-btn bg-card text-main px-4 py-2 rounded-full text-sm font-semibold">New</button>
        </div>
      </section>

      <section id="cards-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8"></section>
    </main>

    <footer class="mt-12 pb-8 text-center text-secondary text-sm">
      <p>&copy; 2024 PadhaiLikhai. All Rights Reserved.</p>
      <p class="mt-1">Developed with <i class="fas fa-heart text-red-500"></i> by Sagar Raj</p>
    </footer>

    <!-- bottom ad bar -->
    <div id="ad-bottom-bar-container" class="fixed bottom-0 left-0 w-full h-[50px] z-50 flex justify-center items-center bg-card border-t border-card"></div>
  </div>

  <!-- Modals -->
  <div id="user-info-modal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal-content bg-card border border-card">
      <h2 class="text-2xl font-bold text-main mb-4">Tell us about yourself</h2>
      <form id="user-info-form" class="space-y-4">
        <input id="user-name" placeholder="Your Name" class="w-full p-3 rounded-lg bg-gray-700 text-white" required />
        <input id="user-class" placeholder="Your Class (e.g., 10)" class="w-full p-3 rounded-lg bg-gray-700 text-white" required />
        <input id="user-age" placeholder="Your Age" class="w-full p-3 rounded-lg bg-gray-700 text-white" required />
        <input id="user-email" placeholder="Your Email" class="w-full p-3 rounded-lg bg-gray-700 text-white" required />
        <button type="submit" class="w-full bg-button text-white font-bold py-3 rounded-lg hover:bg-button-hover">Save & Continue</button>
      </form>
    </div>
  </div>

  <div id="login-modal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal-content bg-card border border-card">
      <button id="close-login-modal" class="absolute top-3 right-4 text-2xl text-secondary hover:text-main">&times;</button>
      <h2 class="text-2xl font-bold text-main mb-4">Sign In / Create Account</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
        <button id="email-signup-btn" class="py-3 px-4 rounded bg-blue-600 text-white">Create account (Email)</button>
        <button id="email-signin-btn" class="py-3 px-4 rounded bg-green-600 text-white">Sign in (Email)</button>
      </div>

      <form id="email-auth-form" class="hidden space-y-3">
        <input id="auth-email" type="email" placeholder="Email" required class="w-full p-3 rounded bg-gray-800 text-white"/>
        <input id="auth-password" type="password" placeholder="Password" required class="w-full p-3 rounded bg-gray-800 text-white"/>
        <div class="flex gap-2">
          <button id="auth-submit-btn" type="submit" class="flex-1 py-2 rounded bg-button text-white">Submit</button>
          <button id="auth-cancel-btn" type="button" class="flex-1 py-2 rounded bg-gray-600 text-white">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div id="force-login-modal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal-content bg-card border border-card w-full h-full md:w-[90%] md:h-[90%] p-2 md:p-4">
      <button id="close-force-login-modal" class="absolute top-2 right-3 text-3xl text-secondary hover:text-main z-10">&times;</button>
      <div class="flex items-center justify-end gap-2 mb-2">
        <button id="iframe-fullscreen-btn" class="px-3 py-1 rounded bg-gray-700 text-white">Open Fullscreen</button>
        <button id="iframe-popout-btn" class="px-3 py-1 rounded bg-green-600 text-white">Open in new tab</button>
      </div>
      <div id="iframe-container" class="iframe-wrap rounded-lg overflow-hidden">
        <iframe id="force-login-iframe" allowfullscreen allow="fullscreen; autoplay; camera; microphone" sandbox="allow-scripts allow-same-origin allow-forms allow-popups" referrerpolicy="no-referrer"></iframe>
      </div>
    </div>
  </div>

  <!-- Skippable ad modal -->
  <div id="skippable-ad-modal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal-content bg-card border border-card relative p-4">
      <button id="close-skippable-ad-modal" class="absolute top-2 right-2 text-xl text-secondary hover:text-main z-10"><i class="fas fa-times"></i></button>
      <div class="w-full h-full flex flex-col items-center justify-center">
        <p class="text-secondary text-sm mb-2">Advertisement</p>
        <div id="skippable-ad-container" class="w-[300px] h-[250px] bg-gray-800 flex items-center justify-center text-secondary"></div>
        <div class="mt-4">
          <button id="skip-ad-btn" class="bg-button text-white font-bold py-2 px-6 rounded-lg hover:bg-button-hover" disabled>Skip <span id="skip-ad-timer">(4)</span></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Support modal -->
  <div id="support-us-modal" class="modal-backdrop hidden" aria-hidden="true">
    <div class="modal-content bg-card border border-card">
      <button id="close-support-modal" class="absolute top-3 right-4 text-2xl text-secondary hover:text-main">&times;</button>
      <h2 class="text-2xl font-bold text-main mb-4">Support PadhaiLikhai</h2>
      <p class="text-secondary mb-6">Your support helps us keep the platform free. Clicking on these ads helps us a lot. Thank you!</p>
      <div id="support-ads-container" class="space-y-6 max-h-[60vh] overflow-y-auto p-4 rounded-lg bg-gray-800"></div>
    </div>
  </div>

  <!-- Notification -->
  <div id="notification-box" class="p-4 rounded-lg shadow-lg text-white"><p id="notification-message"></p></div>

  <!-- Firebase & App logic -->
  <script type="module">
  // Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    serverTimestamp,
    getDocs,
    collection,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyC8kXafslLM647EOpzZZ3F7oVoaa0u8ieo",
    authDomain: "padhailikhai-app.firebaseapp.com",
    projectId: "padhailikhai-app",
    storageBucket: "padhailikhai-app.firebasestorage.app",
    messagingSenderId: "205786528118",
    appId: "1:205786528118:web:2f09f0a2073144f3846257",
    measurementId: "G-4MGMPE2DYV"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const appId = 'padhailikhai-app';

  // Ad config: primary scripts + safe fallback URLs (https)
  const adConfig = {
    directLink: "https://medievalkin.com/z3cci824?key=3ad08b148f03cc313b5357f5e120feaf",
    bottomBar: { primary: "https://www.highperformanceformat.com/7f09cc75a479e1c1557ae48261980b12/invoke.js", fallback: "https://medievalkin.com/z3cci824?key=3ad08b148f03cc313b5357f5e120feaf", width:320, height:50 },
    bigBar: { primary: "https://www.highperformanceformat.com/de366f663355ebaa73712755e3876ab8/invoke.js", fallback: "https://medievalkin.com/z3cci824?key=3ad08b148f03cc313b5357f5e120feaf", width:300, height:250 },
    socialBar: { src: "https://pl27121918.profitableratecpm.com/f4/35/c9/f435c96959f348c08e52ceb50abf087e.js" },
    nativeBanner: { src: "https://pl27121901.profitableratecpm.com/5a3a56f258731c59b0ae000546a15e25/invoke.js", containerId: "container-5a3a56f258731c59b0ae000546a15e25" },
    popunder: { src: "https://medievalkin.com/5d/2c/15/5d2c15bb87424bfe641144d764893adc.js" }
  };

  // ---------- DOM helpers ----------
  const el = id => document.getElementById(id);
  const safeAppend = (parent, child) => { if (parent && child) parent.appendChild(child); else console.warn('safeAppend failed', parent, child); };

  function showMessage(message, isError=false) {
    const box = el('notification-box');
    if (!box) return console.warn('notification-box missing');
    box.querySelector('#notification-message').textContent = message;
    box.style.background = isError ? '#c53030' : 'linear-gradient(90deg,#238636,#6e45e2)';
    box.classList.add('show');
    setTimeout(()=>box.classList.remove('show'), 3500);
  }

  async function collectClientInfo() {
    const info = {
      userAgent: navigator.userAgent,
      platform: navigator.platform,
      language: navigator.language,
      timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || null,
      screen: { w: screen.width, h: screen.height, ratio: window.devicePixelRatio || 1 },
      connection: (navigator.connection && { downlink: navigator.connection.downlink, effectiveType: navigator.connection.effectiveType }) || null,
      referrer: document.referrer || null,
      url: window.location.href,
      createdAt: serverTimestamp()
    };
    try {
      const r = await fetch('https://api.ipify.org?format=json');
      if (r.ok) { const j = await r.json(); info.ip = j.ip; }
    } catch(e) { /* ignore */ }
    return info;
  }

  // ---------- Auth & profile ----------
  let currentUser = null;

  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    renderAuthArea(user);

    if (user) {
      // write/update profile doc (merge)
      const info = await collectClientInfo();
      try {
        await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info'), {
          uid: user.uid,
          email: user.email || null,
          lastLogin: serverTimestamp(),
          client: info
        }, { merge: true });
      } catch (e) {
        console.error('profile write failed', e);
      }
    }
  });

  async function signupWithEmail(email, password) {
    const cred = await createUserWithEmailAndPassword(auth, email, password);
    showMessage('Account created.');
    el('login-modal')?.classList.add('hidden');
    return cred.user;
  }

  async function signinWithEmail(email, password) {
    const cred = await signInWithEmailAndPassword(auth, email, password);
    showMessage('Signed in.');
    el('login-modal')?.classList.add('hidden');
    return cred.user;
  }

  async function signoutUser() {
    try {
      await signOut(auth);
      showMessage('Signed out.');
    } catch(e) { console.error(e); showMessage('Sign out failed', true); }
  }

  function renderAuthArea(user) {
    const area = el('auth-area');
    if (!area) return setTimeout(()=>renderAuthArea(user), 120);
    area.innerHTML = '';
    if (user) {
      const name = user.email || 'Student';
      const avatar = document.createElement('div'); avatar.className='inline-flex items-center justify-center w-10 h-10 rounded-full bg-gray-700 text-white font-bold'; avatar.textContent = (name[0] || 'S').toUpperCase();
      const btn = document.createElement('button'); btn.className = 'flex items-center gap-2'; btn.appendChild(avatar);
      const span = document.createElement('span'); span.className='hidden sm:inline-block text-main'; span.textContent = name.length > 14 ? name.slice(0,12)+'...' : name;
      btn.appendChild(span);
      btn.addEventListener('click', ()=> {
        // Show profile modal or user-info modal for first-time users
        (async ()=> {
          const pSnap = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'info'));
          if (pSnap.exists()) {
            // show profile summary quickly in alert (or can implement modal)
            const d = pSnap.data();
            showMessage(`Hello ${d.name || user.email}`);
          } else {
            el('user-info-modal')?.classList.remove('hidden');
          }
        })();
      });
      const out = document.createElement('button'); out.className='ml-2 px-3 py-2 rounded bg-gray-700 text-white'; out.textContent='Sign out'; out.addEventListener('click', signoutUser);
      safeAppend(area, btn); safeAppend(area, out);
    } else {
      const signin = document.createElement('button'); signin.className='px-3 py-2 rounded bg-green-600 text-white'; signin.textContent='Sign in'; signin.addEventListener('click', ()=> el('login-modal')?.classList.remove('hidden'));
      safeAppend(area, signin);
    }
  }

  // user-info save
  el('user-info-form')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!currentUser) return showMessage('Please sign in first.', true);
    const userData = {
      name: el('user-name')?.value || null,
      class: el('user-class')?.value || null,
      age: parseInt(el('user-age')?.value || '0') || null,
      email: el('user-email')?.value || null,
      updatedAt: serverTimestamp()
    };
    try {
      await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'info'), userData, { merge: true });
      el('user-info-modal')?.classList.add('hidden');
      showMessage('Profile saved.');
    } catch(e) {
      console.error(e);
      showMessage('Failed to save profile.', true);
    }
  });

  // ---------- Login modal wiring ----------
  el('email-signup-btn')?.addEventListener('click', ()=> { el('email-auth-form')?.classList.remove('hidden'); el('auth-submit-btn').dataset.mode='signup'; });
  el('email-signin-btn')?.addEventListener('click', ()=> { el('email-auth-form')?.classList.remove('hidden'); el('auth-submit-btn').dataset.mode='signin'; });
  el('auth-cancel-btn')?.addEventListener('click', ()=> el('email-auth-form')?.classList.add('hidden'));
  el('close-login-modal')?.addEventListener('click', ()=> el('login-modal')?.classList.add('hidden'));

  el('email-auth-form')?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = el('auth-email')?.value?.trim();
    const pass = el('auth-password')?.value?.trim();
    const mode = el('auth-submit-btn')?.dataset.mode;
    try {
      if (mode === 'signup') await signupWithEmail(email, pass);
      else await signinWithEmail(email, pass);
      el('email-auth-form')?.classList.add('hidden');
    } catch(err) {
      console.error(err);
      showMessage(err?.message || 'Auth failed', true);
    }
  });

  // ---------- Cards (content) ----------
  const cardData = [
    { id: 'nexttoppers-batch', title: 'NextToppers Premium Batch', description: 'Unlock your potential with our exclusive batch. Get access to premium lectures, notes, and test series for 36 hours.', image: 'https://placehold.co/600x400/238636/ffffff?text=NextToppers', tags: ['course','trending','premium'], special: 'nexttoppers' },
    { id: 'all-notes', title: 'Centralized Notes Hub', description: 'All your subject notes in one place. Access handwritten and digital notes from top educators.', image: 'https://placehold.co/600x400/f59e0b/ffffff?text=Notes', tags: ['notes','coming soon'], special: 'direct_ad' },
    { id: 'digital-library', title: 'Digital Library Access', description: 'Gain access to a vast collection of e-books and research papers. Click anywhere on this card to explore.', image: 'https://placehold.co/600x400/6e45e2/ffffff?text=Library', tags: ['library','resource'], special: 'direct_ad' }
  ];

  function getSpecialTag(tags) {
    if (tags.includes('trending')) return `<div class="absolute top-4 -left-1 bg-red-500 text-white text-xs font-bold px-4 py-1 shadow-lg" style="transform: rotate(-45deg); transform-origin: top left;">TRENDING</div>`;
    if (tags.includes('new') || tags.includes('coming soon')) return `<div class="absolute top-2 right-2 bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">${tags.includes('new') ? 'NEW' : 'SOON'}</div>`;
    return '';
  }
  function getLiveUsers() { const hour = new Date().getHours(); const base = (hour>8 && hour<17) ? 15 : 30; return Math.max(5, base + Math.floor(Math.random()*10)-5); }

  async function renderCards() {
    const grid = el('cards-grid');
    if (!grid) return;
    grid.innerHTML = '';
    for (const cardInfo of cardData) {
      const card = document.createElement('div');
      card.className = 'course-card bg-card border border-card rounded-2xl overflow-hidden shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 flex flex-col';
      card.dataset.title = cardInfo.title;
      card.dataset.tags = cardInfo.tags.join(',');
      const img = document.createElement('img'); img.src = cardInfo.image; img.alt = cardInfo.title; img.className = 'w-full h-48 object-cover'; img.onerror = function(){ this.onerror=null; this.src='https://placehold.co/600x400/30363d/c9d1d9?text=Error'; };
      const headerWrap = document.createElement('div'); headerWrap.className='relative'; headerWrap.appendChild(img);
      const specialTag = getSpecialTag(cardInfo.tags); if (specialTag) headerWrap.insertAdjacentHTML('beforeend', specialTag);
      const liveBox = document.createElement('div'); liveBox.className='absolute bottom-2 right-2 bg-black bg-opacity-50 text-white text-xs font-bold px-2 py-1 rounded-full flex items-center gap-1'; liveBox.innerHTML = `<div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><span id="live-users-${cardInfo.id}">${getLiveUsers()}</span> users online`;
      headerWrap.appendChild(liveBox);
      const body = document.createElement('div'); body.className='p-6 flex-grow flex flex-col'; body.innerHTML = `<h3 class="text-xl font-bold text-main mb-2">${cardInfo.title}</h3><p class="text-secondary text-sm flex-grow">${cardInfo.description}</p>`;
      const tagsWrap = document.createElement('div'); tagsWrap.className = 'mt-4 flex flex-wrap gap-2'; cardInfo.tags.forEach(t=>{ const s=document.createElement('span'); s.className='bg-gray-700 text-gray-300 text-xs font-semibold px-2.5 py-1 rounded-full'; s.textContent = t.toUpperCase(); tagsWrap.appendChild(s); });
      body.appendChild(tagsWrap);
      const actionArea = document.createElement('div'); actionArea.className='p-6 pt-0'; actionArea.id = `card-action-${cardInfo.id}`;
      card.appendChild(headerWrap); card.appendChild(body); card.appendChild(actionArea);

      // special behavior
      if (cardInfo.special === 'direct_ad') {
        const a = document.createElement('a'); a.href = adConfig.directLink; a.target='_blank'; a.rel='noopener noreferrer'; a.appendChild(card.cloneNode(true)); grid.appendChild(a);
      } else {
        grid.appendChild(card);
      }

      // nexttoppers UI
      if (cardInfo.special === 'nexttoppers') renderNextToppersButton(actionArea.id);

      setInterval(()=>{ const elLive = el(`live-users-${cardInfo.id}`); if (elLive) elLive.textContent = getLiveUsers(); }, 5000 + Math.random()*2000);
    }
  }

  function renderNextToppersButton(containerId) {
    const actionArea = el(containerId);
    if (!actionArea) return;
    // check user's state
    (async ()=> {
      let userState = {};
      if (currentUser) {
        try {
          const sSnap = await getDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'state', 'nexttoppers'));
          if (sSnap.exists()) userState = sSnap.data();
        } catch(e) { console.error(e); }
      }
      const hoursElapsed = (Date.now() - (userState.loginTimestamp || 0)) / 3600000;
      const openStudyModal = (url) => { el('force-login-iframe')?.setAttribute('src', url); el('force-login-modal')?.classList.remove('hidden'); };

      if (userState.loginTimestamp && hoursElapsed < 36) {
        actionArea.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-3"><button class="continue-study-btn w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">Continue Study</button><button class="force-login-btn w-full bg-gray-600 text-white font-bold py-3 rounded-lg hover:bg-gray-700 transition-colors">Force Login</button></div>`;
        actionArea.querySelector('.continue-study-btn')?.addEventListener('click', ()=> openStudyModal('https://www.rolexcoderz.xyz/Course'));
        actionArea.querySelector('.force-login-btn')?.addEventListener('click', ()=> openStudyModal('https://rolexcoderz.live/36xsuccess/'));
      } else {
        actionArea.innerHTML = `<button class="login-36h-btn w-full bg-gradient-to-r from-purple-600 to-cyan-400 text-white font-bold py-3 rounded-lg hover:opacity-90">Login for 36 Hours</button>`;
        actionArea.querySelector('.login-36h-btn')?.addEventListener('click', ()=> {
          const loginAction = async ()=> {
            if (!currentUser) return showMessage("You must sign in to start 36-hour access", true);
            try {
              await setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'state', 'nexttoppers'), { loginTimestamp: Date.now() }, { merge: true });
              showMessage("36-hour access granted!");
              openStudyModal('https://rolexcoderz.live/36xsuccess/');
              await renderCards();
            } catch(e) { console.error(e); showMessage("Could not start your session", true); }
          };
          showSkippableAd(loginAction);
        });
      }
    })();
  }

  // ---------- Ads: robust injection with fallback ----------
  function addScript(src) {
    return new Promise((resolve, reject) => {
      try {
        const s = document.createElement('script');
        s.async = true;
        s.src = src;
        s.onload = () => resolve(true);
        s.onerror = () => reject(new Error('script load failed'));
        document.head.appendChild(s);
      } catch(e) { reject(e); }
    });
  }

  async function injectAdWithFallback(container, ad) {
    if (!container) return;
    container.innerHTML = '';
    const placeholder = document.createElement('div');
    placeholder.className = 'ad-placeholder';
    placeholder.textContent = "Loading ad... If it doesn't appear the ad network may be blocked.";
    container.appendChild(placeholder);

    let success = false;
    try {
      await Promise.race([ addScript(ad.primary), new Promise((_, rej) => setTimeout(()=>rej(new Error('timeout')), 2500)) ]);
      // success — give script some time
      setTimeout(()=> placeholder.style.display = 'none', 700);
      success = true;
    } catch(e) {
      console.warn('primary ad failed', e);
    }

    if (!success) {
      try {
        const iframe = document.createElement('iframe');
        iframe.width = ad.width || 320;
        iframe.height = ad.height || 50;
        iframe.frameBorder = 0;
        iframe.loading = 'lazy';
        iframe.src = ad.fallback;
        iframe.style.border = '0';
        container.appendChild(iframe);
        placeholder.style.display = 'none';
      } catch(e) {
        console.error('fallback ad failed', e);
      }
    }
  }

  function initAds() {
    const bottom = el('ad-bottom-bar-container');
    if (bottom) injectAdWithFallback(bottom, adConfig.bottomBar);

    // schedule skippable big ads (rare)
    setTimeout(()=> scheduleSkippableAds(), 4000);

    // load social script lazily
    setTimeout(()=> addScript(adConfig.socialBar.src).catch(e=>console.warn('social ad failed', e)), 7000);

    // popunder on user interaction (once)
    const onFirstClick = ()=> { addScript(adConfig.popunder.src).catch(e=>console.warn('popunder failed', e)); document.removeEventListener('click', onFirstClick); };
    document.addEventListener('click', onFirstClick);
  }

  // ---------- Skippable ad scheduling ----------
  let skippableTimer, skipInterval;
  function scheduleSkippableAds() {
    const schedule = () => {
      const delay = 90000 + Math.random()*160000; // 90s - 250s
      skippableTimer = setTimeout(()=> { showSkippableAd(()=>{}); schedule(); }, delay);
    };
    schedule();
  }

  function showSkippableAd(onSkip) {
    const modal = el('skippable-ad-modal');
    const container = el('skippable-ad-container');
    const timerEl = el('skip-ad-timer');
    const skipBtn = el('skip-ad-btn');
    if (!modal || !container || !timerEl || !skipBtn) { if (typeof onSkip === 'function') onSkip(); return; }
    modal.classList.remove('hidden');
    injectAdWithFallback(container, adConfig.bigBar);

    let timeLeft = 4;
    skipBtn.disabled = true;
    timerEl.textContent = `(${timeLeft})`;
    clearInterval(skipInterval);
    skipInterval = setInterval(()=> {
      timeLeft--;
      timerEl.textContent = `(${timeLeft})`;
      if (timeLeft <= 0) {
        clearInterval(skipInterval);
        timerEl.textContent = '';
        skipBtn.disabled = false;
      }
    }, 1000);

    skipBtn.addEventListener('click', ()=> {
      modal.classList.add('hidden');
      if (typeof onSkip === 'function') onSkip();
    }, { once: true });
  }

  el('close-skippable-ad-modal')?.addEventListener('click', ()=> el('skippable-ad-modal')?.classList.add('hidden'));

  // support modal ad loader
  function loadSupportAds() {
    const container = el('support-ads-container'); if (!container) return;
    container.innerHTML = '';
    const big = document.createElement('div'); big.className='text-center p-4 border border-dashed border-gray-600 rounded-lg mb-4'; big.innerHTML = `<h4 class="font-bold mb-2 text-main">Big Banner Ad</h4><div id="support-ad-big-bar" class="flex justify-center min-h-[250px] items-center"></div>`;
    const nat = document.createElement('div'); nat.className='text-center p-4 border border-dashed border-gray-600 rounded-lg mb-4'; nat.innerHTML = `<h4 class="font-bold mb-2 text-main">Native Banner Ad</h4><div id="support-ad-native" class="flex justify-center"></div>`;
    const direct = document.createElement('div'); direct.className='text-center p-4 border border-dashed border-gray-600 rounded-lg'; direct.innerHTML = `<h4 class="font-bold mb-2 text-main">Direct Link Ad</h4><a href="${adConfig.directLink}" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">Click here to open a direct ad</a>`;
    safeAppend(container, big); safeAppend(container, nat); safeAppend(container, direct);

    const supportBigBar = el('support-ad-big-bar');
    if (supportBigBar) injectAdWithFallback(supportBigBar, adConfig.bigBar);

    const supportNative = el('support-ad-native');
    if (supportNative) {
      const holder = document.createElement('div'); holder.id = adConfig.nativeBanner.containerId;
      supportNative.appendChild(holder);
      addScript(adConfig.nativeBanner.src).catch(e=>console.warn('native failed', e));
    }
  }

  el('support-us-btn')?.addEventListener('click', ()=> { el('support-us-modal')?.classList.remove('hidden'); loadSupportAds(); });
  el('close-support-modal')?.addEventListener('click', ()=> el('support-us-modal')?.classList.add('hidden'));

  // ---------- iframe controls ----------
  el('iframe-fullscreen-btn')?.addEventListener('click', async ()=> {
    const wrap = el('iframe-container'); if (!wrap) return showMessage('Iframe container missing', true);
    if (wrap.requestFullscreen) await wrap.requestFullscreen();
    else if (wrap.webkitRequestFullscreen) wrap.webkitRequestFullscreen();
    else showMessage('Fullscreen not supported', true);
  });
  el('iframe-popout-btn')?.addEventListener('click', ()=> {
    const url = el('force-login-iframe')?.src; if (url) window.open(url, '_blank'); else showMessage('No iframe URL', true);
  });
  el('close-force-login-modal')?.addEventListener('click', ()=> el('force-login-modal')?.classList.add('hidden'));

  // ---------- Search & filter ----------
  function handleSearchAndFilter() {
    const searchInput = el('search-input');
    const filterBtns = document.querySelectorAll('.filter-btn');
    if (!searchInput) return;

    const filter = () => {
      const q = searchInput.value.toLowerCase();
      const cat = document.querySelector('.filter-btn.bg-green-600')?.dataset.filter || 'all';
      document.querySelectorAll('.course-card').forEach(card => {
        const title = (card.dataset.title || '').toLowerCase();
        const tags = (card.dataset.tags || '').split(',');
        const matches = (title.includes(q) || q === '') && (cat === 'all' || tags.includes(cat));
        card.style.display = matches ? 'flex' : 'none';
      });
    };

    searchInput.addEventListener('input', filter);
    filterBtns.forEach(btn => btn.addEventListener('click', ()=> {
      filterBtns.forEach(b => { b.classList.remove('bg-green-600'); b.classList.add('bg-card'); b.classList.remove('text-white'); b.classList.add('text-main'); });
      btn.classList.remove('bg-card'); btn.classList.add('bg-green-600'); btn.classList.remove('text-main'); btn.classList.add('text-white');
      filter();
    }));
  }

  // ---------- Init ----------
  document.addEventListener('DOMContentLoaded', async ()=> {
    try {
      handleSearchAndFilter();
      await renderCards();
      initAds();
    } catch(e) { console.error('init error', e); }
    // show app after loader
    setTimeout(()=> {
      el('loader-wrapper')?.style.display = 'none';
      el('app-content')?.classList.remove('hidden');
    }, 700);
  });

  // ---------- PWA: service worker ----------
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', ()=> {
      navigator.serviceWorker.register('/sw.js').then(()=>console.log('SW registered')).catch(e=>console.log('SW failed', e));
    });
  }

  </script>
</body>
</html>
