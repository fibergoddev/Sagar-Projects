<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatterHub v2 - Advanced Real-Time Chat</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        .light ::-webkit-scrollbar-track { background: #e2e8f0; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .light ::-webkit-scrollbar-thumb { background: #94a3b8; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .light ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        .chat-bubble-sent { background-color: #2563eb; color: white; border-radius: 1.25rem 1.25rem 0.25rem 1.25rem; }
        .chat-bubble-received { background-color: #334155; color: white; border-radius: 1.25rem 1.25rem 1.25rem 0.25rem; }
        .light .chat-bubble-received { background-color: #e2e8f0; color: #1e293b; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        .toast-in { animation: toastIn 0.5s forwards; }
        @keyframes toastIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-out { animation: toastOut 0.5s forwards; }
        @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }

        /* Futuristic SVG Loader Animation */
        #loader-logo {
            stroke-width: 2;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw 2s ease-in-out forwards;
        }
        @keyframes draw {
            to {
                stroke-dashoffset: 0;
            }
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 antialiased overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900 flex items-center justify-center z-[100]">
        <div class="w-32 h-32">
            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path id="loader-logo" d="M75 25 C50 25, 50 50, 25 50 S0 75, 25 75 C50 75, 50 50, 75 50 S100 25, 75 25" stroke="#2563eb" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed bottom-5 right-5 z-[60] space-y-3"></div>

    <!-- Main Application Container -->
    <div id="app-container" class="h-screen w-screen flex flex-col items-center justify-center p-0 md:p-4 transition-all duration-300">
        
        <div id="chat-view" class="h-full w-full max-w-7xl fade-in transition-all duration-300">
            <div class="flex h-full bg-slate-800 dark:border border-slate-700 md:rounded-2xl shadow-2xl shadow-slate-900/50 light:bg-white light:text-slate-800">
                
                <aside class="w-full md:w-1/3 lg:w-1/4 h-full flex-col border-r border-slate-700 light:border-slate-200 hidden md:flex" id="sidebar">
                    <header class="p-4 border-b border-slate-700 light:border-slate-200 flex justify-between items-center flex-shrink-0">
                        <h2 class="text-xl font-bold text-white light:text-slate-900">Chats</h2>
                        <div class="flex items-center space-x-2">
                           <button id="theme-toggle" aria-label="Toggle theme" class="p-2 rounded-full hover:bg-slate-700 light:hover:bg-slate-200 transition-colors">
                                <i data-feather="sun" class="w-5 h-5 dark-icon"></i>
                                <i data-feather="moon" class="w-5 h-5 light-icon"></i>
                           </button>
                            <div class="relative" x-data="{ open: false }">
                                <button @click="open = !open" aria-label="Settings" class="p-2 rounded-full hover:bg-slate-700 light:hover:bg-slate-200 transition-colors">
                                    <i data-feather="settings" class="w-5 h-5"></i>
                                </button>
                                <div x-show="open" @click.away="open = false" class="absolute right-0 mt-2 w-48 bg-slate-700 light:bg-white light:border light:border-slate-200 rounded-lg shadow-lg py-1 z-10" x-transition>
                                    <a href="#" id="profile-button" class="block px-4 py-2 text-sm text-slate-200 light:text-slate-700 hover:bg-slate-600 light:hover:bg-slate-100">Profile</a>
                                    <a href="#" id="logout-button" class="block px-4 py-2 text-sm text-slate-200 light:text-slate-700 hover:bg-slate-600 light:hover:bg-slate-100">Logout</a>
                                </div>
                            </div>
                        </div>
                    </header>
                    <div id="user-list" class="flex-grow overflow-y-auto p-2 space-y-1"></div>
                </aside>

                <main class="w-full md:w-2/3 lg:w-3/4 h-full flex flex-col" id="main-content">
                    <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center p-4">
                        <i data-feather="message-circle" class="w-24 h-24 text-slate-600 light:text-slate-300 mb-4"></i>
                        <h3 class="text-2xl font-bold text-white light:text-slate-900">Select a chat to begin</h3>
                        <p class="text-slate-400 light:text-slate-500 max-w-sm mt-2">Your conversations are private and secure.</p>
                    </div>
                    
                    <div id="chat-window" class="hidden h-full flex-col">
                        <header id="chat-header" class="p-4 border-b border-slate-700 light:border-slate-200 flex items-center space-x-3 flex-shrink-0"></header>
                        <div id="messages-container" class="flex-grow p-4 overflow-y-auto space-y-4"></div>
                        <footer class="p-4 flex-shrink-0">
                            <form id="message-form" class="flex items-center space-x-3">
                                <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" class="w-full bg-slate-700 light:bg-slate-100 light:border-slate-300 border border-slate-600 rounded-full px-4 py-2 text-white light:text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all">
                                <button type="submit" aria-label="Send message" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full p-3 flex-shrink-0 transition-colors">
                                    <i data-feather="send" class="w-5 h-5"></i>
                                </button>
                            </form>
                        </footer>
                    </div>
                </main>
            </div>
        </div>

        <!-- Authentication Modal -->
        <div id="auth-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50 fade-in" style="pointer-events: auto;">
             <div class="bg-slate-800 border border-slate-700 rounded-2xl p-8 shadow-2xl shadow-slate-900/50 w-full max-w-md m-4 light:bg-white light:text-slate-800">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-white light:text-slate-900">Welcome to ChatterHub</h1>
                    <p class="text-slate-400 light:text-slate-500 mt-2">Securely connect with others in real-time.</p>
                </div>
                <div x-data="{ tab: 'login' }">
                    <div class="flex border-b border-slate-700 light:border-slate-200 mb-6">
                        <button @click="tab = 'login'" :class="{ 'border-blue-500 text-white light:text-slate-900': tab === 'login', 'border-transparent text-slate-400 light:text-slate-500': tab !== 'login' }" class="flex-1 py-2 text-center font-medium border-b-2 transition-colors duration-300">Login</button>
                        <button @click="tab = 'register'" :class="{ 'border-blue-500 text-white light:text-slate-900': tab === 'register', 'border-transparent text-slate-400 light:text-slate-500': tab !== 'register' }" class="flex-1 py-2 text-center font-medium border-b-2 transition-colors duration-300">Register</button>
                    </div>
                    <form id="login-form" x-show="tab === 'login'" class="space-y-4">
                        <input type="email" id="login-email" required placeholder="Email" class="w-full bg-slate-700 light:bg-slate-100 border border-slate-600 light:border-slate-300 rounded-lg px-3 py-2 text-white light:text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="login-password" required placeholder="Password" class="w-full bg-slate-700 light:bg-slate-100 border border-slate-600 light:border-slate-300 rounded-lg px-3 py-2 text-white light:text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Login</button>
                    </form>
                    <form id="register-form" x-show="tab === 'register'" class="space-y-4">
                        <input type="text" id="register-username" required placeholder="Username" class="w-full bg-slate-700 light:bg-slate-100 border border-slate-600 light:border-slate-300 rounded-lg px-3 py-2 text-white light:text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="email" id="register-email" required placeholder="Email" class="w-full bg-slate-700 light:bg-slate-100 border border-slate-600 light:border-slate-300 rounded-lg px-3 py-2 text-white light:text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <input type="password" id="register-password" required placeholder="Password" class="w-full bg-slate-700 light:bg-slate-100 border border-slate-600 light:border-slate-300 rounded-lg px-3 py-2 text-white light:text-slate-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300">Create Account</button>
                    </form>
                </div>
                <p id="auth-error" class="text-red-400 text-sm mt-4 text-center"></p>
            </div>
        </div>

        <!-- Generic Modals -->
        <div id="profile-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-70 fade-in" style="pointer-events: auto;"></div>
        <div id="edit-message-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-70 fade-in" style="pointer-events: auto;"></div>
        <div id="confirm-modal-container"></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, serverTimestamp, orderBy, updateDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCkP9D9OerXWTaE16VXsWE107p0NF5jT0s",
            authDomain: "chatterhub-official.firebaseapp.com",
            projectId: "chatterhub-official",
            storageBucket: "chatterhub-official.appspot.com",
            messagingSenderId: "558999266613",
            appId: "1:558999266613:web:03bf5ad2fe0f76f46e187c",
            measurementId: "G-9KLVHPQ1RP"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const loadingOverlay = document.getElementById('loading-overlay');
        const authModal = document.getElementById('auth-modal');
        const chatView = document.getElementById('chat-view');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authError = document.getElementById('auth-error');
        const logoutButton = document.getElementById('logout-button');
        const userList = document.getElementById('user-list');
        const welcomeScreen = document.getElementById('welcome-screen');
        const chatWindow = document.getElementById('chat-window');
        const chatHeader = document.getElementById('chat-header');
        const messagesContainer = document.getElementById('messages-container');
        const messageForm = document.getElementById('message-form');
        const messageInput = document.getElementById('message-input');
        const profileButton = document.getElementById('profile-button');
        const profileModalContainer = document.getElementById('profile-modal');
        const editMessageModalContainer = document.getElementById('edit-message-modal');
        const themeToggleButton = document.getElementById('theme-toggle');
        const toastContainer = document.getElementById('toast-container');
        const confirmModalContainer = document.getElementById('confirm-modal-container');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('main-content');

        let currentUser = null;
        let currentChatPartner = null;
        let unsubscribeMessages = null;

        const applyTheme = (theme) => {
            if (theme === 'light') {
                document.documentElement.classList.add('light');
                document.documentElement.classList.remove('dark');
            } else {
                document.documentElement.classList.add('dark');
                document.documentElement.classList.remove('light');
            }
            document.querySelector('.light-icon').style.display = theme === 'light' ? 'none' : 'block';
            document.querySelector('.dark-icon').style.display = theme === 'light' ? 'block' : 'none';
            feather.replace();
        };

        themeToggleButton.addEventListener('click', () => {
            const currentTheme = localStorage.getItem('theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        });
        
        const showToast = (message, type = 'info') => {
            if (toastContainer.children.length >= 3) {
                toastContainer.firstChild.remove();
            }
            const colors = { info: 'bg-blue-500', success: 'bg-green-500', error: 'bg-red-500' };
            const toast = document.createElement('div');
            toast.className = `toast-in text-white px-6 py-3 rounded-lg shadow-lg ${colors[type]}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => {
                toast.classList.remove('toast-in');
                toast.classList.add('toast-out');
                toast.addEventListener('animationend', () => toast.remove());
            }, 3000);
        };

        const showConfirmModal = (title, message, onConfirm) => {
            confirmModalContainer.innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center z-[90] fade-in" style="pointer-events: auto;">
                <div class="bg-slate-800 light:bg-white border border-slate-700 light:border-slate-200 rounded-2xl p-8 shadow-2xl w-full max-w-sm m-4">
                    <h2 class="text-xl font-bold mb-4">${title}</h2>
                    <p class="text-slate-400 light:text-slate-500 mb-6">${message}</p>
                    <div class="flex justify-end space-x-3">
                        <button id="confirm-cancel-btn" class="px-4 py-2 rounded-lg hover:bg-slate-700 light:hover:bg-slate-200">Cancel</button>
                        <button id="confirm-ok-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Confirm</button>
                    </div>
                </div>
            </div>`;

            const closeModal = () => { confirmModalContainer.innerHTML = ''; };
            confirmModalContainer.querySelector('#confirm-cancel-btn').addEventListener('click', closeModal);
            confirmModalContainer.querySelector('#confirm-ok-btn').addEventListener('click', () => {
                onConfirm();
                closeModal();
            });
        };

        onAuthStateChanged(auth, user => {
            setTimeout(() => {
                if (user) {
                    currentUser = user;
                    authModal.classList.add('hidden');
                    chatView.classList.remove('blur-sm', 'pointer-events-none');
                    loadUsers();
                    if(document.readyState === 'complete') { showToast(`Welcome back!`, 'success'); }
                } else {
                    currentUser = null;
                    authModal.classList.remove('hidden');
                    chatView.classList.add('blur-sm', 'pointer-events-none');
                    if (unsubscribeMessages) unsubscribeMessages();
                    userList.innerHTML = '';
                    welcomeScreen.classList.remove('hidden');
                    chatWindow.classList.add('hidden');
                }
                feather.replace();
            }, 100);
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            authError.textContent = '';
            try {
                const q = query(collection(db, "users"), where("username", "==", username));
                const querySnapshot = await getDocs(q);
                if (!querySnapshot.empty) {
                    throw new Error("Username already taken.");
                }
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                await setDoc(doc(db, "users", user.uid), { uid: user.uid, username, email, createdAt: serverTimestamp() });
                showToast('Account created successfully!', 'success');
            } catch (error) {
                authError.textContent = error.message;
                showToast(`Registration failed: ${error.message}`, 'error');
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authError.textContent = '';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authError.textContent = "Invalid email or password.";
                showToast('Login failed.', 'error');
            }
        });

        logoutButton.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await signOut(auth);
                showToast('You have been logged out.', 'info');
            } catch (error) {
                showToast('Logout failed. Please try again.', 'error');
            }
        });

        profileButton.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                const userDoc = await getDoc(doc(db, "users", currentUser.uid));
                const userData = userDoc.data();
                profileModalContainer.innerHTML = `
                    <div class="bg-slate-800 light:bg-white border border-slate-700 light:border-slate-200 rounded-2xl p-8 shadow-2xl w-full max-w-md m-4">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold">Edit Profile</h2>
                            <button id="close-profile-modal" class="p-2 rounded-full hover:bg-slate-700 light:hover:bg-slate-200"><i data-feather="x" class="w-6 h-6"></i></button>
                        </div>
                        <form id="profile-form" class="space-y-4">
                            <input type="text" id="profile-username" required value="${userData.username || ''}" class="w-full bg-slate-700 light:bg-slate-100 border border-slate-600 light:border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="number" id="profile-age" value="${userData.age || ''}" placeholder="Age" class="w-full bg-slate-700 light:bg-slate-100 border border-slate-600 light:border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <input type="text" id="profile-location" value="${userData.location || ''}" placeholder="Location" class="w-full bg-slate-700 light:bg-slate-100 border border-slate-600 light:border-slate-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <div class="flex justify-end pt-4">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save Changes</button>
                            </div>
                        </form>
                    </div>`;
                profileModalContainer.classList.remove('hidden');
                feather.replace();
                
                document.getElementById('close-profile-modal').addEventListener('click', () => profileModalContainer.classList.add('hidden'));
                document.getElementById('profile-form').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const username = document.getElementById('profile-username').value;
                    const age = document.getElementById('profile-age').value;
                    const location = document.getElementById('profile-location').value;
                    try {
                        await setDoc(doc(db, "users", currentUser.uid), { username, age: age ? parseInt(age) : null, location }, { merge: true });
                        showToast('Profile updated!', 'success');
                        profileModalContainer.classList.add('hidden');
                    } catch (error) {
                         showToast('Failed to update profile.', 'error');
                    }
                });
            } catch (error) {
                showToast('Could not load profile data.', 'error');
            }
        });

        const loadUsers = () => {
            const q = query(collection(db, "users"));
            onSnapshot(q, (querySnapshot) => {
                userList.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const user = doc.data();
                    if (user.uid !== currentUser.uid) {
                        const userElement = document.createElement('div');
                        userElement.className = 'flex items-center p-3 hover:bg-slate-700 light:hover:bg-slate-100 rounded-lg cursor-pointer transition-colors duration-200';
                        userElement.dataset.uid = user.uid;
                        userElement.addEventListener('click', () => startChat(user));
                        userElement.innerHTML = `
                            <div class="w-10 h-10 rounded-full bg-slate-600 flex items-center justify-center font-bold text-white mr-3 flex-shrink-0">${user.username.charAt(0).toUpperCase()}</div>
                            <div class="flex-grow"><p class="font-semibold">${user.username}</p></div>`;
                        userList.appendChild(userElement);
                    }
                });
            }, (error) => {
                console.error("Error loading users:", error);
                showToast("Could not load user list.", "error");
            });
        };

        const startChat = (user) => {
            currentChatPartner = user;
            welcomeScreen.classList.add('hidden');
            chatWindow.classList.remove('hidden');
            chatWindow.classList.add('flex');
            const backButtonHTML = `<button id="back-to-users" class="md:hidden p-2 mr-2 rounded-full hover:bg-slate-700 light:hover:bg-slate-200"><i data-feather="arrow-left"></i></button>`;
            chatHeader.innerHTML = `
                ${backButtonHTML}
                <div class="w-12 h-12 rounded-full bg-slate-600 flex items-center justify-center font-bold text-white flex-shrink-0">${user.username.charAt(0).toUpperCase()}</div>
                <div><h3 class="text-lg font-bold">${user.username}</h3></div>`;
            
            sidebar.classList.remove('flex');
            sidebar.classList.add('hidden');
            mainContent.classList.remove('md:w-2/3', 'lg:w-3/4');
            mainContent.classList.add('w-full');

            document.getElementById('back-to-users').addEventListener('click', () => {
                sidebar.classList.remove('hidden');
                sidebar.classList.add('flex');
                mainContent.classList.add('md:w-2/3', 'lg:w-3/4');
                mainContent.classList.remove('w-full');
                chatWindow.classList.add('hidden');
                welcomeScreen.classList.remove('hidden');
                currentChatPartner = null;
                if (unsubscribeMessages) unsubscribeMessages();
            });

            if (unsubscribeMessages) unsubscribeMessages();
            loadMessages();
            feather.replace();
        };

        const loadMessages = () => {
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            const messagesRef = collection(db, "chats", chatId, "messages");
            const q = query(messagesRef, orderBy("timestamp", "asc"));

            unsubscribeMessages = onSnapshot(q, (querySnapshot) => {
                messagesContainer.innerHTML = '';
                querySnapshot.forEach((doc) => { renderMessage(doc); });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, (error) => {
                console.error("Error loading messages:", error);
                showToast("Could not load messages.", "error");
            });
        };

        const renderMessage = (doc) => {
            const message = doc.data();
            const messageId = doc.id;
            const messageElement = document.createElement('div');
            const isSent = message.senderId === currentUser.uid;
            
            messageElement.className = `flex items-end space-x-2 group ${isSent ? 'justify-end' : 'justify-start'}`;
            
            let contentHTML;
            if (message.deleted) {
                contentHTML = `<p class="italic text-slate-400">This message was deleted</p>`;
            } else {
                contentHTML = `<p class="break-words">${message.text}</p>
                <span class="text-xs opacity-70 block text-right mt-1 flex-shrink-0">
                    ${message.edited ? '(edited) ' : ''}
                    ${message.timestamp ? new Date(message.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : ''}
                </span>`;
            }

            const bubbleHTML = `<div class="max-w-xs md:max-w-md lg:max-w-lg px-4 py-2 ${isSent ? 'chat-bubble-sent' : 'chat-bubble-received'}">${contentHTML}</div>`;

            const menuButtonHTML = isSent && !message.deleted ? `
                <div class="hidden group-hover:flex items-center">
                    <button aria-label="Edit message" data-message-id="${messageId}" data-message-text="${message.text}" class="edit-btn p-1 rounded-full hover:bg-slate-700 light:hover:bg-slate-200"><i data-feather="edit-2" class="w-4 h-4"></i></button>
                    <button aria-label="Delete message" data-message-id="${messageId}" class="delete-btn p-1 rounded-full hover:bg-slate-700 light:hover:bg-slate-200"><i data-feather="trash-2" class="w-4 h-4 text-red-500"></i></button>
                </div>` : '';

            messageElement.innerHTML = isSent ? menuButtonHTML + bubbleHTML : bubbleHTML;
            messagesContainer.appendChild(messageElement);
            feather.replace();
        };
        
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = messageInput.value.trim();
            if (text === '' || !currentChatPartner) return;
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');
            try {
                await addDoc(collection(db, "chats", chatId, "messages"), { text, senderId: currentUser.uid, receiverId: currentChatPartner.uid, timestamp: serverTimestamp() });
                messageInput.value = '';
            } catch (error) {
                showToast("Message could not be sent.", "error");
            }
        });

        messagesContainer.addEventListener('click', (e) => {
            const editBtn = e.target.closest('.edit-btn');
            const deleteBtn = e.target.closest('.delete-btn');
            const chatId = [currentUser.uid, currentChatPartner.uid].sort().join('_');

            if (editBtn) {
                const messageId = editBtn.dataset.messageId;
                const currentText = editBtn.dataset.messageText;
                
                editMessageModalContainer.innerHTML = `
                    <div class="bg-slate-800 light:bg-white border border-slate-700 light:border-slate-200 rounded-2xl p-8 shadow-2xl w-full max-w-md m-4">
                        <h2 class="text-2xl font-bold mb-4">Edit Message</h2>
                        <form id="edit-message-form">
                            <textarea id="edit-message-input" class="w-full bg-slate-700 light:bg-slate-100 border border-slate-600 light:border-slate-300 rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3">${currentText}</textarea>
                            <div class="flex justify-end mt-4 space-x-2">
                                <button type="button" id="cancel-edit" class="px-4 py-2 rounded-lg hover:bg-slate-700 light:hover:bg-slate-200">Cancel</button>
                                <button type="submit" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Save</button>
                            </div>
                        </form>
                    </div>`;
                editMessageModalContainer.classList.remove('hidden');
                
                document.getElementById('cancel-edit').addEventListener('click', () => editMessageModalContainer.classList.add('hidden'));
                document.getElementById('edit-message-form').addEventListener('submit', async (ev) => {
                    ev.preventDefault();
                    const newText = document.getElementById('edit-message-input').value;
                    if (newText.trim() !== '') {
                        const messageRef = doc(db, "chats", chatId, "messages", messageId);
                        try {
                            await updateDoc(messageRef, { text: newText, edited: true });
                            showToast('Message edited!', 'success');
                        } catch (error) {
                            showToast('Failed to edit message.', 'error');
                        }
                    }
                    editMessageModalContainer.classList.add('hidden');
                });
            }

            if (deleteBtn) {
                const messageId = deleteBtn.dataset.messageId;
                showConfirmModal(
                    'Delete Message', 
                    'Are you sure you want to delete this message?', 
                    async () => {
                        const messageRef = doc(db, "chats", chatId, "messages", messageId);
                        try {
                            await updateDoc(messageRef, { deleted: true, text: '' });
                            showToast('Message deleted.', 'info');
                        } catch (error) {
                            showToast('Failed to delete message.', 'error');
                        }
                    }
                );
            }
        });
        
        window.onload = () => {
            setTimeout(() => {
                loadingOverlay.style.pointerEvents = 'none';
                loadingOverlay.style.opacity = '0';
                loadingOverlay.addEventListener('transitionend', () => loadingOverlay.remove());
            }, 2000);
            
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
            feather.replace();
        };

    </script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</body>
</html>
